server {
    listen 80;
    listen 443 ssl;
    
    # TLS/SSL Configuration
    ssl_certificate /etc/nginx/certs/server.crt;
    ssl_certificate_key /etc/nginx/certs/server.key;
    ssl_client_certificate /etc/nginx/certs/ca.crt;
    # Enforce client certificate verification for mTLS
    ssl_verify_client on; # use 'optional' if you prefer logic-based allow
    ssl_verify_depth 2;   # depth 1 is enough if directly signed by root CA
    
    # SSL protocols and ciphers
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    # WebSocket support for /onis/ws/
    location /onis/ws/ {
        proxy_pass http://web:4000/ws/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        # mTLS pass-through headers for backend authorization / auditing
        proxy_set_header X-Ssl-Client-Verify $ssl_client_verify;
        proxy_set_header X-Ssl-Client-Subject $ssl_client_s_dn;
        proxy_set_header X-Ssl-Client-Serial $ssl_client_serial;
    }

    # ----------------------------------------------
    # 1. HAUPTANWENDUNG (Node.js App auf Port 4000)
    # Erreichbar über http://localhost/onis/
    # ----------------------------------------------
    
    # OPTIONAL: Leitet http://localhost/onis auf http://localhost/onis/ um
    location = /onis {
        return 301 /onis/;
    }

    location /onis/ {
        # When ssl_verify_client is 'on', only verified clients reach here.
        # If you change to 'optional', uncomment the guard below.
        if ($ssl_client_verify != SUCCESS) { return 403; }

        proxy_pass http://web:4000/;

        # 1. Deaktiviert die Komprimierung vom Backend, damit der Filter funktioniert
        proxy_set_header Accept-Encoding ""; 
        
        # 2. Definiert, auf welche MIME-Typen der Filter angewendet werden soll
        sub_filter_types text/html application/javascript text/javascript;
        
        # 3. 'off' bedeutet, dass der Filter mehrmals im Dokument ausgeführt wird
        sub_filter_once off;
        
        # KORREKTUREN DER PFADE:
        # 1. Korrigiert Assets (CSS/JS/Images) in HTML (z.B. href="/css/")
        sub_filter 'src="/' 'src="/onis/';
        sub_filter 'href="/' 'href="/onis/';
	    sub_filter 'action="/' 'action="/onis/';
        sub_filter '<head>' '<head><base href="/onis/">';
        
        # ----------------------------------------------------
        # REDIRECT-KORREKTUREN
        # ----------------------------------------------------
        proxy_redirect default; 
        proxy_redirect ~^/(.*)$ /onis/$1;
        proxy_redirect http://localhost:4000/ /onis/;

        # Standard-Proxy-Header
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # mTLS pass-through headers for backend authorization / auditing
        proxy_set_header X-Ssl-Client-Verify $ssl_client_verify;
        proxy_set_header X-Ssl-Client-Subject $ssl_client_s_dn;
        proxy_set_header X-Ssl-Client-Serial $ssl_client_serial;
    }

    # ----------------------------------------------
    # 2. MONGODB WEB-GUI (Mongo Express auf Port 8081)
    # Erreichbar über http://localhost/mongo/
    # ----------------------------------------------
    location /mongo/ {
        if ($ssl_client_verify != SUCCESS) { return 403; }

        proxy_pass http://mongo-express:8081/; 
        
        # Sicherstellen, dass die Header für den Proxy korrekt übergeben werden
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # ----------------------------------------------------
        # REDIRECT-KORREKTUREN für Mongo Express:
        # Mongo Express sendet Redirects oft auf die Wurzel (/)
        # Wir müssen diese auf den korrekten Pfad umleiten.
        # ----------------------------------------------------
        proxy_redirect default;
        proxy_redirect ~^/(.*)$ /mongo/$1;
        
        # ----------------------------------------------------
        # Subfilter für Mongo Express Styles/Skripte (wie von Ihnen eingerichtet)
        # ----------------------------------------------------
        proxy_set_header Accept-Encoding ""; 
        
        sub_filter_types text/html;
        sub_filter_once off;
        
        # Achtung: Die nachfolgenden sub_filter sind wichtig, aber können in manchen
        # Fällen auch Probleme verursachen. Sie sind korrekt, um absolute Pfade
        # im HTML zu korrigieren.
        sub_filter 'href="/' 'href="/mongo/';
        sub_filter 'src="/' 'src="/mongo/';
    }
}