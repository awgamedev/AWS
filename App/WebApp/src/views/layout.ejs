<%
// EJS kann Helper-Funktionen verwenden, wenn sie √ºber den Express-Route-Context √ºbergeben werden.
// Da die CSS/JS-Imports konstant sind, f√ºgen wir sie direkt ein.
// WICHTIG: Die Funktion generateMenuEntries ist hier nicht mehr notwendig, da wir das Partial verwenden.
%>
<!DOCTYPE html>
<html lang="de">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title><%= title %></title>

        <!-- Tailwind CSS -->
        <script src="https://cdn.tailwindcss.com"></script>
        <!-- Alpine.js -->
        <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
        
        <!-- CSS Imports (Vom Original getCSSImports) -->
        <link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
        <link rel="stylesheet" href="/css/layout.css">
        <link rel="stylesheet" href="/css/table.css">
        <!-- Per-view injected styles -->
        <%- styles || '' %>
    </head>
    <body class="bg-gray-50 flex flex-col min-h-screen">
        <!-- 1. Seitenleiste (Sidebar) -->
        <aside id="sidebar" class="sidebar-width bg-gray-900 text-white flex-shrink-0 z-40 transition-all duration-300 shadow-xl border-r border-gray-800">
            <!-- Sidebar-Kopfzeile/Logo -->
            <div class="p-6 flex items-center justify-between border-b border-gray-800">
                <div class="flex items-center space-x-3">
                    <img src="/img/onis-menu-light.png" alt="App Logo"/>
                </div>
                <!-- Toggle-Button f√ºr Mobile -->
                <button id="closeSidebarMobile" class="md:hidden p-1 rounded-full text-gray-400 hover:bg-gray-800 focus:outline-none">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>

            <!-- Sprachauswahl -->
            <!-- <div class="p-4 flex space-x-4 text-xs">
                <a href="/changelang/de" class="text-gray-400 hover:text-white transition">Deutsch</a>
                <a href="/changelang/en" class="text-gray-400 hover:text-white transition">English</a>
                <a href="/changelang/fr" class="text-gray-400 hover:text-white transition">Fran√ßais</a>
            </div> -->

            <!-- NEUE Men√ºeintr√§ge: Werden √ºber das EJS-Partial gerendert -->
            <%- include('../features/menu/views/_menu', { currentPath: currentPath }) %>
        </aside>

        <!-- 2. Hauptinhalt und Kopfzeile (Main Content Area) -->
        <div id="main-content" class="flex-grow flex flex-col">
            <!-- Kopfzeile (Header) -->
            <header class="bg-white shadow-md flex-shrink-0 border-b border-gray-200 sticky top-0 z-50">
                <div class="px-4 sm:px-6 lg:px-8 py-3 flex justify-between items-center">
                    
                    <!-- Linke Seite / Sidebar Toggles -->
                    <div class="flex items-center space-x-3">
                        <!-- Desktop Toggle -->
                        <button id="toggleSidebarDesktop" class="hidden md:block p-2 rounded-lg text-gray-500 hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition duration-150">
                            <svg id="menuIcon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                            <svg id="closeIcon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>

                        <!-- Mobile Toggle -->
                        <button id="openSidebarMobile" class="md:hidden p-2 rounded-lg text-gray-500 hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition duration-150">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                        </button>
                        
                        <h2 class="text-xl font-extrabold text-gray-800"><%= title %></h2>
                    </div>

                    <!-- Profil-Men√º / Dropdown -->
                    <div class="relative z-30">
                        <button id="userMenuButton" class="flex items-center space-x-3 focus:outline-none rounded-full py-1 px-2 hover:bg-gray-100 transition duration-150" aria-expanded="false" aria-haspopup="true">
                            <!-- Anzeige des Nutzernamens -->
                            <span class="text-sm font-medium text-gray-800 hidden sm:block">
                                <%= userName %>
                            </span>
                            <!-- Avatar/Initialen -->
                            <div class="w-10 h-10 rounded-full <%= isLoggedIn ? 'bg-indigo-600' : 'bg-gray-400' %> flex items-center justify-center text-white font-bold text-sm shadow-lg ring-2 ring-indigo-300 overflow-hidden">
                                <% if (userProfile && userProfile.profilePictureBase64) { %>
                                    <img src="<%= userProfile.profilePictureBase64 %>" alt="Avatar" class="w-full h-full object-cover">
                                <% } else { %>
                                    <%= userInitials %>
                                <% } %>
                            </div>
                            <!-- Pfeil-Icon f√ºr Dropdown -->
                            <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>

                        <!-- Dropdown-Men√º (Standardm√§√üig versteckt) -->
                        <div id="userMenuDropdown" class="hidden absolute right-0 mt-2 w-48 origin-top-right rounded-md shadow-xl bg-white ring-1 ring-black ring-opacity-5" role="menu" aria-orientation="vertical" aria-labelledby="user-menu-button">
                            <div class="py-1" role="none">
                                <!-- Hier wird das Partial eingef√ºgt! -->
                                <%- include('../features/menu/views/user_menu') %>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <script src="/lib/jquery/dist/jquery.min.js"></script>
            <script src="/lib/font-awesome/js/all.min.css"></script>
            <script src="/js/layout.js"></script>
            <script src="/js/layoutHead.js"></script>

            <!-- Utility scripts  -->
            <script src="/js/utilities/api-script.js"></script>
            <script src="/js/utilities/date_and_time_script.js"></script>
            <script src="/js/utilities/dom-script.js"></script>
            <script src="/js/utilities/list-script.js"></script>
            <script src="/js/utilities/modal-script.js"></script>
            <script src="/js/utilities/parsing-script.js"></script>
            <script src="/js/utilities/plattform-script.js"></script>
            <script src="/js/utilities/routing-script.js"></script>

            <!-- Hauptinhalt (Content) -->
            <main class="flex-grow p-2 sm:p-6 lg:p-8">
                <!-- Der bodyContent wird hier als unescaped HTML eingef√ºgt -->
                <%- bodyContent %>
            </main>

            <!-- 3. Fu√üzeile (Footer) -->
            <footer class="bg-white border-t border-gray-200 flex-shrink-0 sticky bottom-0 z-50">
                <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8">
                    <p class="text-center text-sm text-gray-500">
                        &copy; <%= new Date().getFullYear() %> Milchviehbetrieb Onis Markushof üêÆ. Alle Rechte vorbehalten.
                    </p>
                </div>
            </footer>
        </div>

        <!-- Overlay f√ºr Mobile, um die Seitenleiste zu schlie√üen -->
        <div id="sidebar-overlay" class="fixed inset-0 bg-black opacity-0 z-40 hidden transition-opacity duration-300 md:hidden" onclick="toggleSidebar(false)"></div>
     </body>
</html>