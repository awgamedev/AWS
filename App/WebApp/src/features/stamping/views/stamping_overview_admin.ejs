<div class="bg-white p-3 rounded-lg shadow-sm mb-3">
    <div class="text-xs sm:text-sm font-medium text-gray-600 mb-2"><%= __('SELECT_PERIOD') %></div>
    <div class="flex flex-col sm:flex-row gap-2">
        <select id="month-select" class="flex-1 p-2 text-sm border border-gray-300 rounded-md focus:ring-1 focus:ring-blue-400 focus:border-blue-400">
            <% monthOptions.forEach(option => { %>
                <option value="<%= option.value %>" <%= option.isSelected ? 'selected' : '' %>>
                    <%= option.name %>
                </option>
            <% }); %>
        </select>
        <select id="year-select" class="flex-1 sm:flex-none sm:w-28 p-2 text-sm border border-gray-300 rounded-md focus:ring-1 focus:ring-blue-400 focus:border-blue-400">
            <% yearOptions.forEach(option => { %>
                <option value="<%= option.value %>" <%= option.isSelected ? 'selected' : '' %>>
                    <%= option.value %>
                </option>
            <% }); %>
        </select>
    </div>
</div>

<div class="bg-blue-50 border border-blue-200 p-3 rounded-lg shadow-sm mb-3">
    <h2 class="text-xs sm:text-sm font-medium mb-1 text-gray-700"><%= __('TOTAL_MONTHLY_HOURS_ALL_EMPLOYEES').replace('%s', monthName) %></h2>
    <p class="text-xl sm:text-2xl font-bold text-blue-600"><%= totalMonthlyHours %> <%= __('HOURS_SHORT') %></p>
</div>

<div id="employee-overview" class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-3">
    <% if (overviewData.length === 0) { %>
        <div class="bg-white p-3 rounded-lg shadow-sm text-sm text-gray-500 col-span-full"><%= __('NO_EMPLOYEES_OR_STAMPINGS_FOUND') %></div>
    <% } else { %>
        <% overviewData.forEach(userData => { %>
            <div class="bg-white p-3 rounded-lg shadow-sm mb-3 border-l-3 border-blue-400">
                <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-2 pb-2 border-b border-gray-200 gap-2">
                    <div class="flex items-center space-x-2">
                        <div class="w-8 h-8 rounded-full bg-indigo-600 flex items-center justify-center text-white font-bold text-xs shadow-sm overflow-hidden flex-shrink-0">
                            <% if (profileMap[userData.userId] && profileMap[userData.userId].profilePictureBase64) { %>
                                <img src="<%= profileMap[userData.userId].profilePictureBase64 %>" alt="Avatar" class="w-full h-full object-cover">
                            <% } else { %>
                                <%= userData.userInitials %>
                            <% } %>
                        </div>
                        <h3 class="text-base sm:text-lg font-semibold text-gray-800"><%= userData.username %></h3>
                    </div>
                    <div class="flex items-center justify-between sm:justify-end space-x-2">
                        <span class="text-lg sm:text-xl font-bold text-blue-600"><%= userData.totalHours %> h</span>
                        <button 
                            class="add-stamping-btn px-3 py-2 bg-blue-500 text-white text-sm rounded-md shadow-sm hover:bg-blue-600 active:bg-blue-700 transition duration-150 flex items-center min-h-[36px] min-w-[36px] justify-center"
                            data-user-id="<%= userData.userId %>"
                            data-username="<%= userData.username %>"
                            title="<%= __('ADD_STAMPING_BUTTON') %>"
                        >
                            <i class="fas fa-plus text-sm"></i>
                        </button>
                    </div>
                </div>

                <% if (userData.hoursByReason && Object.keys(userData.hoursByReason).length > 0) { %>
                    <div class="mb-2 p-2 bg-gray-50 border border-gray-200 rounded-md">
                        <h4 class="text-xs font-medium text-gray-600 mb-1"><%= __('HOURS_BY_REASON') %></h4>
                        <div class="space-y-0.5">
                            <% Object.keys(userData.hoursByReason).sort().forEach(reason => { %>
                                <div class="flex justify-between items-center text-xs">
                                    <span class="text-gray-600"><%= reason %></span>
                                    <span class="font-medium text-blue-600"><%= userData.hoursByReason[reason] %> <%= __('HOURS_ABBREVIATION') %></span>
                                </div>
                            <% }); %>
                        </div>
                    </div>
                <% } %>

                <button class="toggle-daily-records w-full text-left text-xs font-medium text-gray-600 mb-1.5 flex items-center justify-between hover:text-gray-800 transition-colors">
                    <span><%= __('DAILY_RECORDS_IN_MONTH').replace('%s', monthName) %></span>
                    <i class="fas fa-chevron-down transition-transform duration-200"></i>
                </button>
                
                <div class="daily-records-container hidden max-h-64 sm:max-h-48 overflow-y-auto border border-gray-200 rounded-md bg-gray-50 -webkit-overflow-scrolling-touch">
                    <%
                        const sortedDays = Object.keys(userData.dailyWork).sort();
                        if (sortedDays.length === 0) {
                    %>
                        <div class="p-3 text-xs text-gray-500 text-center"><%= __('NO_STAMPINGS_IN_SELECTED_MONTH') %></div>
                    <% } else { %>
                        <% sortedDays.forEach(day => { %>
                            <% const dayData = userData.dailyWork[day]; %>
                            <div class="p-2 border-b border-gray-100 hover:bg-white transition duration-100">
                                <div class="flex flex-col sm:flex-row sm:justify-between sm:items-start gap-1.5">
                                    <span class="text-xs font-medium text-gray-700 whitespace-nowrap"><%= formatDate(new Date(day)) %></span>
                                    <div class="text-left space-y-1.5 flex-1">
                                        <% dayData.pairs.forEach(pair => { %>
                                            <%
                                                const durationDisplay = pair.unclosed ? "" : ` (${pair.duration}h)`;
                                                const timeClass = pair.unclosed ? "text-red-500 font-bold" : "text-gray-700";
                                            %>
                                            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-1.5 sm:gap-0 group">
                                                <div class="flex-1">
                                                    <p class="text-xs break-words text-gray-700">
                                                        <%= pair.in %> - <%= pair.out %> <%= pair.stampingReason || '' %> 
                                                        <span class="text-xs text-gray-500"><%= durationDisplay %></span>
                                                    </p>
                                                </div>
                                                <% if (pair.inId || pair.outId) { %>
                                                    <div class="flex space-x-1.5 opacity-100 sm:opacity-0 sm:group-hover:opacity-100 transition-opacity">
                                                        <button 
                                                            class="edit-stamping-pair-btn px-2 py-1.5 bg-blue-500 text-white text-xs rounded-md hover:bg-blue-600 active:bg-blue-700 transition duration-150 min-h-[32px] min-w-[32px] flex items-center justify-center"
                                                            data-in-id="<%= pair.inId || '' %>"
                                                            data-out-id="<%= pair.outId || '' %>"
                                                            data-date="<%= day %>"
                                                            data-in-time="<%= pair.in %>"
                                                            data-out-time="<%= pair.out %>"
                                                            data-reason="<%= pair.stampingReason || '' %>"
                                                            data-unclosed="<%= pair.unclosed || false %>"
                                                            title="<%= __('EDIT_BUTTON') %>"
                                                        >
                                                            <i class="fas fa-edit"></i>
                                                        </button>
                                                        <button 
                                                            class="delete-stamping-pair-btn px-2 py-1.5 bg-red-500 text-white text-xs rounded-md hover:bg-red-600 active:bg-red-700 transition duration-150 min-h-[32px] min-w-[32px] flex items-center justify-center"
                                                            data-in-id="<%= pair.inId || '' %>"
                                                            data-out-id="<%= pair.outId || '' %>"
                                                            data-pair-display="<%= pair.in %> - <%= pair.out %>"
                                                            title="<%= __('DELETE_BUTTON') %>"
                                                        >
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    </div>
                                                <% } %>
                                            </div>
                                        <% }); %>
                                        <p class="text-xs font-medium <%= dayData.totalTimeHours > 0 ? 'text-blue-600' : 'text-gray-400' %> mt-1 pt-1 border-t border-gray-100">
                                            <%= __('TOTAL_SHORT') %>: <%= dayData.totalTimeHours %> <%= __('HOURS_ABBREVIATION') %>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        <% }); %>
                    <% } %>
                </div>
            </div>
            <% }); %>
    <% } %>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const monthSelect = document.getElementById('month-select');
        const yearSelect = document.getElementById('year-select');
        
        const navigateToSelectedMonth = () => {
            const selectedMonth = monthSelect.value;
            const selectedYear = yearSelect.value;
            // Seite mit den neuen Query-Parametern neu laden
            window.location.href = `/time-tracking/stamping-overview?month=${selectedMonth}&year=${selectedYear}`;
        };

        monthSelect.addEventListener('change', navigateToSelectedMonth);
        yearSelect.addEventListener('change', navigateToSelectedMonth);

        // Toggle daily records collapsible sections
        document.querySelectorAll('.toggle-daily-records').forEach(button => {
            button.addEventListener('click', (e) => {
                e.preventDefault();
                const container = button.nextElementSibling;
                const icon = button.querySelector('i');
                
                if (container.classList.contains('hidden')) {
                    container.classList.remove('hidden');
                    icon.style.transform = 'rotate(180deg)';
                } else {
                    container.classList.add('hidden');
                    icon.style.transform = 'rotate(0deg)';
                }
            });
        });
    });
</script>

<script src="/js/stamping/stamping-admin-script.js"></script>