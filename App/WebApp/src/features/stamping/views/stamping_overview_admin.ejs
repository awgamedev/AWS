<div class="bg-white p-3 rounded-lg shadow-sm mb-3">
    <div class="text-xs sm:text-sm font-medium text-gray-600 mb-2"><%= __('SELECT_PERIOD') %></div>
    <div class="flex flex-row gap-2">
        <select id="month-select" class="flex-1 p-2 text-sm border border-gray-300 rounded-md focus:ring-1 focus:ring-blue-400 focus:border-blue-400">
            <% monthOptions.forEach(option => { %>
                <option value="<%= option.value %>" <%= option.isSelected ? 'selected' : '' %>>
                    <%= option.name %>
                </option>
            <% }); %>
        </select>
        <select id="year-select" class="w-16 p-2 text-sm border border-gray-300 rounded-md focus:ring-1 focus:ring-blue-400 focus:border-blue-400" style="width:5.5em;">
            <% yearOptions.forEach(option => { %>
                <option value="<%= option.value %>" <%= option.isSelected ? 'selected' : '' %>>
                    <%= option.value %>
                </option>
            <% }); %>
        </select>
    </div>
</div>

<!-- Collapsible Manual (German) -->
<div class="mb-4 bg-white rounded-lg shadow-md overflow-hidden border border-gray-200">
    <button id="manual-toggle" class="w-full px-4 py-3 flex items-center justify-between bg-gradient-to-r from-blue-50 to-indigo-50 hover:from-blue-100 hover:to-indigo-100 transition duration-200">
        <div class="flex items-center gap-2">
            <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
            </svg>
            <span class="font-semibold text-gray-800">Bedienungsanleitung ‚Äì Wie funktioniert diese Seite?</span>
        </div>
        <svg id="manual-chevron" class="w-5 h-5 text-gray-600 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
        </svg>
    </button>

    <div id="manual-content" class="hidden px-4 py-4 bg-white border-top border-gray-200">
        <div class="prose prose-sm max-w-none text-gray-700">
            <h3 class="text-lg font-bold text-indigo-700 mb-3 flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                </svg>
                √úbersicht
            </h3>
            <p class="mb-4">
                Diese Seite ist die <strong>Admin-√úbersicht f√ºr Zeit¬≠erfassung</strong>. Sie w√§hlen einen <strong>Monat</strong> und ein <strong>Jahr</strong>, sehen die <strong>Gesamtstunden</strong> aller Mitarbeiter und erhalten pro Mitarbeiter eine detaillierte Aufstellung inklusive <strong>Stunden nach Grund</strong> und <strong>t√§glicher Stempelungen</strong>.
            </p>

            <h3 class="text-lg font-bold text-indigo-700 mb-3 mt-5 flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                </svg>
                Zeitraum w√§hlen
            </h3>
            <ul class="list-disc list-inside space-y-2 mb-4">
                <li><strong>Monat/Jahr</strong>: Oben k√∂nnen Sie den gew√ºnschten Monat und das Jahr ausw√§hlen. Die Seite l√§dt mit den neuen Werten automatisch neu.</li>
                <li><strong>Direkte Navigation</strong>: Die URL aktualisiert die Parameter (<code>month</code>, <code>year</code>), sodass Sie Ansichten teilen oder bookmarken k√∂nnen.</li>
            </ul>

            <h3 class="text-lg font-bold text-indigo-700 mb-3 mt-5 flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                </svg>
                Monats√ºbersicht
            </h3>
            <ul class="list-disc list-inside space-y-2 mb-4">
                <li><strong>Gesamtstunden</strong>: Zeigt die Summe aller erfassten Stunden aller Mitarbeiter f√ºr den gew√§hlten Monat.</li>
            </ul>

            <h3 class="text-lg font-bold text-indigo-700 mb-3 mt-5 flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                </svg>
                Mitarbeiterkarten
            </h3>
            <ul class="list-disc list-inside space-y-2 mb-4">
                <li><strong>Avatar/Initialen</strong>: Zeigt das Profilbild oder die Initialen des Mitarbeiters.</li>
                <li><strong>Monatssumme</strong>: Dick gedruckte Stundenanzahl pro Mitarbeiter.</li>
                <li><strong>Stunden nach Grund</strong>: Optionaler Block mit Aufschl√ºsselung (z.‚ÄØB. Projekt, Urlaub, Krankheit), falls Daten vorhanden sind.</li>
                <li><strong>Stempelung hinzuf√ºgen</strong>: √úber die <span class="font-semibold">Plus-Schaltfl√§che</span> f√ºgen Sie dem Mitarbeiter schnell eine neue Stempelung hinzu.</li>
            </ul>

            <h3 class="text-lg font-bold text-indigo-700 mb-3 mt-5 flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
                </svg>
                Tagesaufzeichnungen
            </h3>
            <ul class="list-disc list-inside space-y-2 mb-4">
                <li><strong>Auf-/Zuklappen</strong>: Mit der Zeile ‚ÄûTagesaufzeichnungen im Monat ‚Ä¶‚Äú klappen Sie den Bereich ein/aus.</li>
                <li><strong>Eintr√§ge</strong>: Pro Tag sehen Sie alle Paare von <em>Ein-/Ausstempelungen</em> inkl. optionalem Grund.</li>
                <li><strong>Gesamtdauer pro Tag</strong>: Unter den Eintr√§gen wird die Summe der Stunden des Tages angezeigt.</li>
                <li><strong>Offene Stempelungen</strong>: Fehlt eine Ausstempelung, wird keine Dauer angezeigt, bis die Stempelung abgeschlossen ist.</li>
            </ul>

            <h3 class="text-lg font-bold text-indigo-700 mb-3 mt-5 flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                </svg>
                Stempelungen bearbeiten
            </h3>
            <ul class="list-disc list-inside space-y-2 mb-4">
                <li><strong>Bearbeiten</strong>: Klicken Sie das <em>Stift-Icon</em>, um Zeiten, Datum oder Grund eines Paares anzupassen.</li>
                <li><strong>L√∂schen</strong>: Entfernen Sie ein Paar √ºber das <em>M√ºlleimer-Icon</em>. Es erscheint eine Sicherheitsabfrage.</li>
            </ul>

            <h3 class="text-lg font-bold text-indigo-700 mb-3 mt-5 flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                </svg>
                Stempelung hinzuf√ºgen
            </h3>
            <ul class="list-disc list-inside space-y-2 mb-4">
                <li><strong>Plus-Schaltfl√§che</strong>: Oben rechts auf der Mitarbeiterkarte eine neue Stempelung erfassen.</li>
                <li><strong>Details</strong>: Uhrzeiten, Datum und optional einen Grund vergeben.</li>
            </ul>

            <h3 class="text-lg font-bold text-indigo-700 mb-3 mt-5 flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                Besondere Funktionen
            </h3>
            <ul class="list-disc list-inside space-y-2 mb-4">
                <li><strong>Scrollbare Bereiche</strong>: Lange Tageslisten sind kompakt dargestellt und scrollbar.</li>
                <li><strong>Profilbilder</strong>: Anzeige des Profilbilds, ansonsten Initialen.</li>
                <li><strong>Responsives Layout</strong>: Funktioniert auf Desktop und Mobilger√§ten √ºbersichtlich.</li>
            </ul>

            <h3 class="text-lg font-bold text-indigo-700 mb-3 mt-5 flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                </svg>
                Tipps & Tricks
            </h3>
            <ul class="list-disc list-inside space-y-2 mb-2">
                <li><strong>Datumsnavigation</strong>: Wechseln Sie Monat/Jahr direkt ‚Äì die Ansicht aktualisiert sich automatisch.</li>
                <li><strong>Vergleiche</strong>: Nutzen Sie die Gesamtstunden oben, um Teams oder Monate zu vergleichen.</li>
                <li><strong>Datenqualit√§t</strong>: Achten Sie auf offene Stempelungen und erg√§nzen Sie fehlende Ausstempelungen zeitnah.</li>
            </ul>

            <div class="mt-4 p-4 bg-indigo-50 border-l-4 border-indigo-500 rounded">
                <p class="text-sm">
                    <strong>üí° Hinweis:</strong> Verwenden Sie die Bearbeiten-/L√∂schen-Aktionen verantwortungsvoll, da √Ñnderungen direkt in die Monatsstatistik einflie√üen.
                </p>
            </div>
        </div>
    </div>
</div>

<div class="bg-blue-50 border border-blue-200 p-3 rounded-lg shadow-sm mb-3">
    <h2 class="text-xs sm:text-sm font-medium mb-1 text-gray-700"><%= __('TOTAL_MONTHLY_HOURS_ALL_EMPLOYEES').replace('%s', monthName) %></h2>
    <p class="text-xl sm:text-2xl font-bold text-blue-600"><%= totalMonthlyHours %> <%= __('HOURS_SHORT') %></p>
</div>

<div id="employee-overview" class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-3">
    <% if (overviewData.length === 0) { %>
        <div class="bg-white p-3 rounded-lg shadow-sm text-sm text-gray-500 col-span-full"><%= __('NO_EMPLOYEES_OR_STAMPINGS_FOUND') %></div>
    <% } else { %>
        <% overviewData.forEach(userData => { %>
            <div class="bg-white p-3 rounded-lg shadow-sm mb-3 border-l-3 border-blue-400">
                <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-2 pb-2 border-b border-gray-200 gap-2">
                    <div class="flex items-center space-x-2">
                        <div class="w-8 h-8 rounded-full bg-indigo-600 flex items-center justify-center text-white font-bold text-xs shadow-sm overflow-hidden flex-shrink-0">
                            <% if (profileMap[userData.userId] && profileMap[userData.userId].profilePictureBase64) { %>
                                <img src="<%= profileMap[userData.userId].profilePictureBase64 %>" alt="Avatar" class="w-full h-full object-cover">
                            <% } else { %>
                                <%= userData.userInitials %>
                            <% } %>
                        </div>
                        <h3 class="text-base sm:text-lg font-semibold text-gray-800"><%= userData.username %></h3>
                    </div>
                    <div class="flex items-center justify-between sm:justify-end space-x-2">
                        <span class="text-lg sm:text-xl font-bold text-blue-600"><%= userData.totalHours %> h</span>
                        <button 
                            class="add-stamping-btn px-3 py-2 bg-blue-500 text-white text-sm rounded-md shadow-sm hover:bg-blue-600 active:bg-blue-700 transition duration-150 flex items-center min-h-[36px] min-w-[36px] justify-center"
                            data-user-id="<%= userData.userId %>"
                            data-username="<%= userData.username %>"
                            title="<%= __('ADD_STAMPING_BUTTON') %>"
                        >
                            <i class="fas fa-plus text-sm"></i>
                        </button>
                    </div>
                </div>

                <% if (userData.hoursByReason && Object.keys(userData.hoursByReason).length > 0) { %>
                    <div class="mb-2 p-2 bg-gray-50 border border-gray-200 rounded-md">
                        <h4 class="text-xs font-medium text-gray-600 mb-1"><%= __('HOURS_BY_REASON') %></h4>
                        <div class="space-y-0.5">
                            <% Object.keys(userData.hoursByReason).sort().forEach(reason => { %>
                                <div class="flex justify-between items-center text-xs">
                                    <span class="text-gray-600"><%= reason %></span>
                                    <span class="font-medium text-blue-600"><%= userData.hoursByReason[reason] %> <%= __('HOURS_ABBREVIATION') %></span>
                                </div>
                            <% }); %>
                        </div>
                    </div>
                <% } %>

                <button class="toggle-daily-records w-full text-left text-xs font-medium text-gray-600 mb-1.5 flex items-center justify-between hover:text-gray-800 transition-colors">
                    <span><%= __('DAILY_RECORDS_IN_MONTH').replace('%s', monthName) %></span>
                    <i class="fas fa-chevron-down transition-transform duration-200"></i>
                </button>
                
                <div class="daily-records-container hidden max-h-64 sm:max-h-48 overflow-y-auto border border-gray-200 rounded-md bg-gray-50 -webkit-overflow-scrolling-touch">
                    <%
                        const sortedDays = Object.keys(userData.dailyWork).sort();
                        if (sortedDays.length === 0) {
                    %>
                        <div class="p-3 text-xs text-gray-500 text-center"><%= __('NO_STAMPINGS_IN_SELECTED_MONTH') %></div>
                    <% } else { %>
                        <% sortedDays.forEach(day => { %>
                            <% const dayData = userData.dailyWork[day]; %>
                            <div class="p-2 border-b border-gray-100 hover:bg-white transition duration-100">
                                <div class="flex flex-col sm:flex-row sm:justify-between sm:items-start gap-1.5">
                                    <span class="text-xs font-medium text-gray-700 whitespace-nowrap"><%= formatDate(new Date(day)) %></span>
                                    <div class="text-left space-y-1.5 flex-1">
                                        <% dayData.pairs.forEach(pair => { %>
                                            <%
                                                const durationDisplay = pair.unclosed ? "" : ` (${pair.duration}h)`;
                                                const timeClass = pair.unclosed ? "text-red-500 font-bold" : "text-gray-700";
                                            %>
                                            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-1.5 sm:gap-0 group">
                                                <div class="flex-1">
                                                    <p class="text-xs break-words text-gray-700">
                                                        <%= pair.in %> - <%= pair.out %> <%= pair.stampingReason || '' %> 
                                                        <span class="text-xs text-gray-500"><%= durationDisplay %></span>
                                                    </p>
                                                </div>
                                                <% if (pair.inId || pair.outId) { %>
                                                    <div class="flex space-x-1.5 opacity-100 sm:opacity-0 sm:group-hover:opacity-100 transition-opacity">
                                                        <button 
                                                            class="edit-stamping-pair-btn px-2 py-1.5 bg-blue-500 text-white text-xs rounded-md hover:bg-blue-600 active:bg-blue-700 transition duration-150 min-h-[32px] min-w-[32px] flex items-center justify-center"
                                                            data-in-id="<%= pair.inId || '' %>"
                                                            data-out-id="<%= pair.outId || '' %>"
                                                            data-date="<%= day %>"
                                                            data-in-time="<%= pair.in %>"
                                                            data-out-time="<%= pair.out %>"
                                                            data-reason="<%= pair.stampingReason || '' %>"
                                                            data-unclosed="<%= pair.unclosed || false %>"
                                                            title="<%= __('EDIT_BUTTON') %>"
                                                        >
                                                            <i class="fas fa-edit"></i>
                                                        </button>
                                                        <button 
                                                            class="delete-stamping-pair-btn px-2 py-1.5 bg-red-500 text-white text-xs rounded-md hover:bg-red-600 active:bg-red-700 transition duration-150 min-h-[32px] min-w-[32px] flex items-center justify-center"
                                                            data-in-id="<%= pair.inId || '' %>"
                                                            data-out-id="<%= pair.outId || '' %>"
                                                            data-pair-display="<%= pair.in %> - <%= pair.out %>"
                                                            title="<%= __('DELETE_BUTTON') %>"
                                                        >
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    </div>
                                                <% } %>
                                            </div>
                                        <% }); %>
                                        <p class="text-xs font-medium <%= dayData.totalTimeHours > 0 ? 'text-blue-600' : 'text-gray-400' %> mt-1 pt-1 border-t border-gray-100">
                                            <%= __('TOTAL_SHORT') %>: <%= dayData.totalTimeHours %> <%= __('HOURS_ABBREVIATION') %>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        <% }); %>
                    <% } %>
                </div>
            </div>
            <% }); %>
    <% } %>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const monthSelect = document.getElementById('month-select');
        const yearSelect = document.getElementById('year-select');
        const manualToggle = document.getElementById('manual-toggle');
        const manualContent = document.getElementById('manual-content');
        const manualChevron = document.getElementById('manual-chevron');
        
        const navigateToSelectedMonth = () => {
            const selectedMonth = monthSelect.value;
            const selectedYear = yearSelect.value;
            // Seite mit den neuen Query-Parametern neu laden
            window.location.href = `time-tracking/stamping-overview?month=${selectedMonth}&year=${selectedYear}`;
        };

        monthSelect.addEventListener('change', navigateToSelectedMonth);
        yearSelect.addEventListener('change', navigateToSelectedMonth);

        // Manual: expand/collapse
        if (manualToggle && manualContent && manualChevron) {
            manualToggle.addEventListener('click', () => {
                const isHidden = manualContent.classList.contains('hidden');
                if (isHidden) {
                    manualContent.classList.remove('hidden');
                    manualChevron.style.transform = 'rotate(180deg)';
                } else {
                    manualContent.classList.add('hidden');
                    manualChevron.style.transform = 'rotate(0deg)';
                }
            });
        }

        // Toggle daily records collapsible sections
        document.querySelectorAll('.toggle-daily-records').forEach(button => {
            button.addEventListener('click', (e) => {
                e.preventDefault();
                const container = button.nextElementSibling;
                const icon = button.querySelector('i');
                
                if (container.classList.contains('hidden')) {
                    container.classList.remove('hidden');
                    icon.style.transform = 'rotate(180deg)';
                } else {
                    container.classList.add('hidden');
                    icon.style.transform = 'rotate(0deg)';
                }
            });
        });
    });
</script>

<script src="/js/stamping/stamping-admin-script.js"></script>