<%
const ACTIVE_CLASSES = "text-indigo-400 bg-gray-800";
const INACTIVE_CLASSES = "text-gray-300";

const { prefix, icon, text, subitems, currentPath, roles, user } = locals;

// Hilfsfunktion zur Überprüfung der Benutzerrolle
const hasRole = (user, requiredRoles) => {
    if (!user || !user.role) {
        return false;
    }
    if (!requiredRoles) {
        return true; // Keine Rolle erforderlich
    }
    const roleArray = Array.isArray(requiredRoles) ? requiredRoles : [requiredRoles];
    return roleArray.includes(user.role);
};

// Prüfe, ob der Benutzer die erforderliche Rolle hat
if (!hasRole(user, roles)) {
    return; // Nicht anzeigen, wenn Rolle nicht passt
}

// Logik, um zu prüfen, ob das Dropdown beim Laden offen sein muss
const isParentActive = currentPath.startsWith(prefix);

// 1. **Muss ein String sein**, da Alpine.js das Attribut als String liest.
const initialOpenStateString = isParentActive ? 'true' : 'false'; 
const initialIsActiveString = isParentActive ? 'true' : 'false';
%>

<div 
    x-data="{ 
        open: JSON.parse('<%= initialOpenStateString %>'), 
        isActive: JSON.parse('<%= initialIsActiveString %>'), 
        prefix: '<%= prefix %>' 
    }" 
    class="space-y-1"
>
    
    <button 
        type="button" 
        @click="open = !open" 
        data-sidebar-role="dropdown-toggle"
        :class="isActive ? '<%= ACTIVE_CLASSES %>' : '<%= INACTIVE_CLASSES %>'"
        class="sidebar-item group flex items-center justify-between w-full space-x-3 p-3 rounded-xl hover:bg-gray-800 transition duration-150"
    >
        <div class="flex items-center space-x-3">
            <span class="<%= icon %>"></span> 
            <span class="sidebar-item-text text-sm font-medium transition-opacity duration-300"><%= text %></span>
        </div>
        
        <span class="fa-solid fa-chevron-down w-4 h-4 transition-transform duration-200" :class="{ 'rotate-180': open }"></span>
    </button>

    <div class="ml-4 pl-2 border-l border-gray-700 space-y-1" x-show="open" x-collapse>
        <% subitems.forEach(item => { %>
            <%- item %>
        <% }); %>
    </div>
</div>