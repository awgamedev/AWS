<%
const getStatusLabel = (status) => {
    switch (status) {
      case "pending": return __("STATUS_PENDING");
      case "in-progress": return __("STATUS_IN_PROGRESS");
      case "completed": return __("STATUS_COMPLETED");
      default: return status;
    }
};

const createTaskTitle = __("CREATE_NEW_TASK");
%>

<div>
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-1 mb-1">
        <div class="flex items-center justify-between sm:justify-start gap-1">
            <button id="prev-week" class="px-2 py-2 bg-gray-200 text-gray-700 font-medium rounded-lg shadow hover:bg-gray-300 transition duration-150 flex items-center">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
            </button>
            
            <div class="flex-1 sm:flex-none text-center">
                <p class="text-base md:text-lg text-gray-800 font-semibold" id="current-week-range"><%= weekRange %></p>
                <p class="text-xs text-gray-500" id="week-offset-display"></p>
            </div>
            
            <button id="next-week" class="px-2 py-2 bg-gray-200 text-gray-700 font-medium rounded-lg shadow hover:bg-gray-300 transition duration-150 flex items-center">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
            </button>
        </div>
        
        <div class="w-full sm:w-auto sm:ml-auto flex flex-row items-stretch items-center gap-1 sm:gap-3">
            <!-- <button id="switch-to-list-view" class="text-[22px] sm:text-sm font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 focus:ring-2 focus:ring-gray-400 focus:outline-none touch-manipulation flex items-center justify-center">
                <span class="inline-block sm:hidden"><i class="fa fa-list"></i></span>
                <span class="hidden sm:inline"><%= __('SWITCH_TO_LIST_VIEW') %></span>
            </button> -->
            <button id="open-task-modal" class="px-2 py-0 sm:py-2 text-[22px] sm:text-sm font-medium text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 focus:ring-2 focus:ring-indigo-500 focus:outline-none touch-manipulation flex items-center justify-center">
                <%= __("CREATE_TASK_BUTTON") %>
            </button>
            <button id="today-week" class="px-2 py-0 sm:py-2 text-[22px] sm:text-sm font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 focus:ring-2 focus:ring-gray-400 focus:outline-none touch-manipulation flex items-center justify-center">
                <span class="inline-block sm:hidden"><i class="fa fa-calendar-week"></i></span>
                <span class="hidden sm:inline">
                    <%= __("THIS_WEEK") %>
                </span>
            </button>
            <!-- Manual button: always a button, book icon, label hidden on mobile -->
            <button id="manual-toggle" type="button" class="px-2 py-0 sm:py-2 flex items-center gap-2 bg-gradient-to-r from-blue-50 to-indigo-50 hover:from-blue-100 hover:to-indigo-100 text-blue-700 rounded transition duration-200 border border-blue-100 focus:outline-none" title="<%= __('SHOW_MANUAL') %>">
                <i class="fas fa-book-open"></i>
            </button>
        </div>
    </div>
</div>

<!-- Collapsible Manual (hidden by default, shown on mobile, toggled by button) -->
<div class="mb-1 bg-white rounded-lg shadow-md overflow-hidden">
    <div id="manual-content" class="px-4 py-4 bg-white border-t border-gray-200 hidden">
        <div class="prose prose-sm max-w-none text-gray-700">
            <!-- ...manual content unchanged... -->
            <h3 class="text-lg font-bold text-indigo-700 mb-3 flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                </svg>
                √úbersicht
            </h3>
            <p class="mb-4">
                Diese Seite ist ein <strong>Aufgabenplaner</strong>, der Aufgaben nach <strong>Mitarbeitern</strong> und <strong>Wochentagen</strong> organisiert. 
                Sie k√∂nnen Aufgaben erstellen, bearbeiten, zuweisen, verschieben und deren Status verwalten. Die Ansicht zeigt eine wochenbasierte 
                √úbersicht aller Aufgaben im Team.
            </p>
             <h3 class="text-lg font-bold text-indigo-700 mb-3 mt-5 flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                </svg>
                Zeitraum w√§hlen
            </h3>
            <ul class="list-disc list-inside space-y-2 mb-4">
                <li><strong>Monat/Jahr</strong>: Oben k√∂nnen Sie den gew√ºnschten Monat und das Jahr ausw√§hlen. Die Seite l√§dt mit den neuen Werten automatisch neu.</li>
                <li><strong>Direkte Navigation</strong>: Die URL aktualisiert die Parameter (<code>month</code>, <code>year</code>), sodass Sie Ansichten teilen oder bookmarken k√∂nnen.</li>
            </ul>

            <h3 class="text-lg font-bold text-indigo-700 mb-3 mt-5 flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                </svg>
                Monats√ºbersicht
            </h3>
            <ul class="list-disc list-inside space-y-2 mb-4">
                <li><strong>Gesamtstunden</strong>: Zeigt die Summe aller erfassten Stunden aller Mitarbeiter f√ºr den gew√§hlten Monat.</li>
            </ul>

            <h3 class="text-lg font-bold text-indigo-700 mb-3 mt-5 flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                </svg>
                Mitarbeiterkarten
            </h3>
            <ul class="list-disc list-inside space-y-2 mb-4">
                <li><strong>Avatar/Initialen</strong>: Zeigt das Profilbild oder die Initialen des Mitarbeiters.</li>
                <li><strong>Monatssumme</strong>: Dick gedruckte Stundenanzahl pro Mitarbeiter.</li>
                <li><strong>Stunden nach Grund</strong>: Optionaler Block mit Aufschl√ºsselung (z.‚ÄØB. Projekt, Urlaub, Krankheit), falls Daten vorhanden sind.</li>
                <li><strong>Stempelung hinzuf√ºgen</strong>: √úber die <span class="font-semibold">Plus-Schaltfl√§che</span> f√ºgen Sie dem Mitarbeiter schnell eine neue Stempelung hinzu.</li>
            </ul>

            <h3 class="text-lg font-bold text-indigo-700 mb-3 mt-5 flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
                </svg>
                Tagesaufzeichnungen
            </h3>
            <ul class="list-disc list-inside space-y-2 mb-4">
                <li><strong>Auf-/Zuklappen</strong>: Mit der Zeile ‚ÄûTagesaufzeichnungen im Monat ‚Ä¶‚Äú klappen Sie den Bereich ein/aus.</li>
                <li><strong>Eintr√§ge</strong>: Pro Tag sehen Sie alle Paare von <em>Ein-/Ausstempelungen</em> inkl. optionalem Grund.</li>
                <li><strong>Gesamtdauer pro Tag</strong>: Unter den Eintr√§gen wird die Summe der Stunden des Tages angezeigt.</li>
                <li><strong>Offene Stempelungen</strong>: Fehlt eine Ausstempelung, wird keine Dauer angezeigt, bis die Stempelung abgeschlossen ist.</li>
            </ul>

            <h3 class="text-lg font-bold text-indigo-700 mb-3 mt-5 flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                </svg>
                Stempelungen bearbeiten
            </h3>
            <ul class="list-disc list-inside space-y-2 mb-4">
                <li><strong>Bearbeiten</strong>: Klicken Sie das <em>Stift-Icon</em>, um Zeiten, Datum oder Grund eines Paares anzupassen.</li>
                <li><strong>L√∂schen</strong>: Entfernen Sie ein Paar √ºber das <em>M√ºlleimer-Icon</em>. Es erscheint eine Sicherheitsabfrage.</li>
            </ul>

            <h3 class="text-lg font-bold text-indigo-700 mb-3 mt-5 flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                </svg>
                Stempelung hinzuf√ºgen
            </h3>
            <ul class="list-disc list-inside space-y-2 mb-4">
                <li><strong>Plus-Schaltfl√§che</strong>: Oben rechts auf der Mitarbeiterkarte eine neue Stempelung erfassen.</li>
                <li><strong>Details</strong>: Uhrzeiten, Datum und optional einen Grund vergeben.</li>
            </ul>

            <h3 class="text-lg font-bold text-indigo-700 mb-3 mt-5 flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                Besondere Funktionen
            </h3>
            <ul class="list-disc list-inside space-y-2 mb-4">
                <li><strong>Scrollbare Bereiche</strong>: Lange Tageslisten sind kompakt dargestellt und scrollbar.</li>
                <li><strong>Profilbilder</strong>: Anzeige des Profilbilds, ansonsten Initialen.</li>
                <li><strong>Responsives Layout</strong>: Funktioniert auf Desktop und Mobilger√§ten √ºbersichtlich.</li>
            </ul>

            <h3 class="text-lg font-bold text-indigo-700 mb-3 mt-5 flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                </svg>
                Tipps & Tricks
            </h3>
            <ul class="list-disc list-inside space-y-2 mb-2">
                <li><strong>Datumsnavigation</strong>: Wechseln Sie Monat/Jahr direkt ‚Äì die Ansicht aktualisiert sich automatisch.</li>
                <li><strong>Vergleiche</strong>: Nutzen Sie die Gesamtstunden oben, um Teams oder Monate zu vergleichen.</li>
                <li><strong>Datenqualit√§t</strong>: Achten Sie auf offene Stempelungen und erg√§nzen Sie fehlende Ausstempelungen zeitnah.</li>
            </ul>

            <div class="mt-4 p-4 bg-indigo-50 border-l-4 border-indigo-500 rounded">
                <p class="text-sm">
                    <strong>üí° Hinweis:</strong> Verwenden Sie die Bearbeiten-/L√∂schen-Aktionen verantwortungsvoll, da √Ñnderungen direkt in die Monatsstatistik einflie√üen.
                </p>
            </div>
            <!-- ...rest of manual content unchanged... -->
        </div>
    </div>
</div>

<div id="task-content-container" class="flex-1 min-h-0 overflow-y-auto">
    <!-- Initial view: task board -->
    <div class="task-board-content">
        <%- include('./task_board_content.ejs', { users, tasksByDayAndUser, daysOfWeek, __: __ }) %>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loading-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg p-6 shadow-xl">
        <div class="flex items-center space-x-3">
            <svg class="animate-spin h-8 w-8 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span class="text-gray-700 font-medium"><%= __("LOADING") || "Loading..." %></span>
        </div>
    </div>
</div>

<script>
    window.CREATE_MODAL_TITLE = "<%= createTaskTitle %>";
    window.CURRENT_WEEK_OFFSET = "<%= typeof weekOffset !== 'undefined' ? weekOffset : 0 %>";
    window.taskTranslations = {
        viewSwitch: {
            list: "<%= __('SWITCH_TO_LIST_VIEW') %>",
            board: "<%= __('SWITCH_TO_BOARD_VIEW') %>"
        },
        unassigned: "<%= __('UNASSIGNED') %>",
        cancel: "<%= __('CANCEL') %>",
        dragConfirmTitle: "<%= __('DRAG_CONFIRM_TITLE') %>",
        dragTask: "<%= __('DRAG_TASK') %>",
        dragUser: "<%= __('DRAG_USER') %>",
        dragStartDate: "<%= __('DRAG_START_DATE') %>",
        dragEndDate: "<%= __('DRAG_END_DATE') %>",
        dragConfirmButton: "<%= __('DRAG_CONFIRM_BUTTON') %>",
        dragMoving: "<%= __('DRAG_MOVING') %>",
        contextMenuChangePriority: "<%= __('CONTEXT_MENU_CHANGE_PRIORITY') %>",
        contextMenuDeleteTask: "<%= __('CONTEXT_MENU_DELETE_TASK') %>",
        contextMenuPriorityHigh: "<%= __('CONTEXT_MENU_PRIORITY_HIGH') %>",
        contextMenuPriorityMedium: "<%= __('CONTEXT_MENU_PRIORITY_MEDIUM') %>",
        contextMenuPriorityLow: "<%= __('CONTEXT_MENU_PRIORITY_LOW') %>",
        confirmDeleteTask: "<%= __('CONFIRM_DELETE_TASK') %>",
        unassignedTaskDetails: "<%= __('UNASSIGNED_TASK_DETAILS') %>",
        assignToMe: "<%= __('ASSIGN_TO_ME') %>",
        assigning: "<%= __('ASSIGNING') %>",
        assignToYourselfMessage: "<%= __('ASSIGN_TO_YOURSELF_MESSAGE') %>",
        dateRange: "<%= __('DATE_RANGE') %>"
    };

    // Manual toggle functionality (hidden by default on all devices)
    document.addEventListener('DOMContentLoaded', function() {
        const manualToggle = document.getElementById('manual-toggle');
        const manualContent = document.getElementById('manual-content');
        if (manualToggle && manualContent) {
            manualToggle.addEventListener('click', function() {
                manualContent.classList.toggle('hidden');
            });
        }
    });
</script>

<script src="/js/task/task-combined-script.js"></script>
