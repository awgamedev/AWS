<%
const getStatusLabel = (status) => {
    switch (status) {
      case "pending": return __("STATUS_PENDING");
      case "in-progress": return __("STATUS_IN_PROGRESS");
      case "completed": return __("STATUS_COMPLETED");
      default: return status;
    }
};

const createTaskTitle = __("CREATE_NEW_TASK");
%>

<div class="mb-3 md:mb-4">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-3">
        <div class="flex items-center justify-between sm:justify-start gap-3">
            <button id="prev-week" class="px-3 py-2 bg-gray-200 text-gray-700 font-medium rounded-lg shadow hover:bg-gray-300 transition duration-150 flex items-center">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                <span class="ml-1 hidden sm:inline"><%= __("PREVIOUS") %></span>
            </button>
            
            <div class="flex-1 sm:flex-none text-center">
                <p class="text-base md:text-lg text-gray-800 font-semibold" id="current-week-range"><%= weekRange %></p>
                <p class="text-xs text-gray-500" id="week-offset-display"></p>
            </div>
            
            <button id="next-week" class="px-3 py-2 bg-gray-200 text-gray-700 font-medium rounded-lg shadow hover:bg-gray-300 transition duration-150 flex items-center">
                <span class="mr-1 hidden sm:inline"><%= __("NEXT") %></span>
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
            </button>
        </div>
        
        <div class="w-full sm:w-auto sm:ml-auto flex flex-row items-stretch items-center gap-1 sm:gap-3">
            <!-- <button id="switch-to-list-view" class="px-1 py-0.5 sm:px-4 sm:py-2 text-[22px] sm:text-sm font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 focus:ring-2 focus:ring-gray-400 focus:outline-none touch-manipulation flex items-center justify-center">
                <span class="inline-block sm:hidden"><i class="fa fa-list"></i></span>
                <span class="hidden sm:inline"><%= __('SWITCH_TO_LIST_VIEW') %></span>
            </button> -->
            <button id="open-task-modal" class="px-1 py-0.5 sm:px-4 sm:py-2 text-[22px] sm:text-sm font-medium text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 focus:ring-2 focus:ring-indigo-500 focus:outline-none touch-manipulation flex items-center justify-center">
                <%= __("CREATE_TASK_BUTTON") %>
            </button>
            <button id="today-week" class="px-1 py-0.5 sm:px-4 sm:py-2 text-[22px] sm:text-sm font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 focus:ring-2 focus:ring-gray-400 focus:outline-none touch-manipulation flex items-center justify-center">
                <span class="inline-block sm:hidden"><i class="fa fa-calendar-week"></i></span>
                <span class="hidden sm:inline">
                    <%= __("THIS_WEEK") %>
                </span>
            </button>
        </div>
    </div>
</div>

<!-- Collapsible Manual (German) -->
<div class="hidden sm:block mb-4 bg-white rounded-lg shadow-md overflow-hidden border border-gray-200">
    <button id="manual-toggle" class="w-full px-4 py-3 flex items-center justify-between bg-gradient-to-r from-blue-50 to-indigo-50 hover:from-blue-100 hover:to-indigo-100 transition duration-200">
        <div class="flex items-center gap-2">
            <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
            </svg>
            <span class="font-semibold text-gray-800">Bedienungsanleitung - Wie funktioniert diese Seite?</span>
        </div>
        <svg id="manual-chevron" class="w-5 h-5 text-gray-600 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
        </svg>
    </button>
    
    <div id="manual-content" class="hidden px-4 py-4 bg-white border-t border-gray-200">
        <div class="prose prose-sm max-w-none text-gray-700">
            
            <h3 class="text-lg font-bold text-indigo-700 mb-3 flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                </svg>
                √úbersicht
            </h3>
            <p class="mb-4">
                Diese Seite ist ein <strong>Aufgabenplaner</strong>, der Aufgaben nach <strong>Mitarbeitern</strong> und <strong>Wochentagen</strong> organisiert. 
                Sie k√∂nnen Aufgaben erstellen, bearbeiten, zuweisen, verschieben und deren Status verwalten. Die Ansicht zeigt eine wochenbasierte 
                √úbersicht aller Aufgaben im Team.
            </p>

            <h3 class="text-lg font-bold text-indigo-700 mb-3 mt-5 flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                </svg>
                Wochennavigation
            </h3>
            <ul class="list-disc list-inside space-y-2 mb-4">
                <li><strong>"Zur√ºck" Pfeil-Button (links)</strong>: Springt zur vorherigen Woche</li>
                <li><strong>Wochenbereich (Mitte)</strong>: Zeigt den aktuellen Datumsbereich (z.B. "18. Nov - 24. Nov")</li>
                <li><strong>"Weiter" Pfeil-Button (rechts)</strong>: Springt zur n√§chsten Woche</li>
                <li><strong>"Diese Woche" Button</strong>: Kehrt zur aktuellen Kalenderwoche zur√ºck</li>
            </ul>

            <h3 class="text-lg font-bold text-indigo-700 mb-3 mt-5 flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                </svg>
                Aufgaben erstellen
            </h3>
            <ul class="list-disc list-inside space-y-2 mb-4">
                <li><strong>"Aufgabe erstellen" Button (oben rechts)</strong>: √ñffnet ein Modal-Fenster zum Erstellen einer neuen Aufgabe</li>
                <li><strong>Leere Zelle anklicken</strong>: Klicken Sie auf eine leere Tageszelle, um direkt eine Aufgabe f√ºr diesen Mitarbeiter und Tag zu erstellen</li>
                <li><strong>"+ Aufgabe hinzuf√ºgen" Button</strong>: Erscheint in Zellen mit bereits vorhandenen Aufgaben - klicken Sie darauf, um eine weitere Aufgabe hinzuzuf√ºgen</li>
            </ul>
            <p class="ml-6 mb-4 text-sm text-gray-600">
                <em>Im Formular k√∂nnen Sie eingeben:</em> Aufgabenname, Beschreibung, Mitarbeiter-Zuweisung, Start- und Enddatum, Status (Ausstehend/In Bearbeitung/Abgeschlossen) und Priorit√§t (Hoch/Mittel/Niedrig).
            </p>

            <h3 class="text-lg font-bold text-indigo-700 mb-3 mt-5 flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                </svg>
                Aufgaben bearbeiten
            </h3>
            <ul class="list-disc list-inside space-y-2 mb-4">
                <li><strong>Auf eine Aufgabenkarte klicken</strong>: √ñffnet das Bearbeitungsformular mit allen Aufgabendetails</li>
                <li><strong>Rechtsklick auf Aufgabe</strong>: Zeigt ein Kontextmen√º mit Schnellaktionen:
                    <ul class="list-circle list-inside ml-6 mt-1 space-y-1">
                        <li>Priorit√§t √§ndern (Hoch/Mittel/Niedrig)</li>
                        <li>Aufgabe l√∂schen</li>
                    </ul>
                </li>
            </ul>

            <h3 class="text-lg font-bold text-indigo-700 mb-3 mt-5 flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path>
                </svg>
                Aufgaben verschieben (Drag & Drop)
            </h3>
            <ul class="list-disc list-inside space-y-2 mb-4">
                <li><strong>Aufgabe ziehen</strong>: Klicken und halten Sie eine Aufgabenkarte, dann ziehen Sie sie zu einer anderen Zelle</li>
                <li><strong>Zielzelle</strong>: Die Zelle, in die Sie ziehen, wird hervorgehoben (gr√ºner Rahmen)</li>
                <li><strong>Best√§tigungsdialog</strong>: Beim Loslassen erscheint ein Dialog mit den neuen Details:
                    <ul class="list-circle list-inside ml-6 mt-1 space-y-1">
                        <li>Neuer zugewiesener Mitarbeiter</li>
                        <li>Neues Start- und Enddatum (basierend auf dem neuen Wochentag)</li>
                        <li>Best√§tigen oder Abbrechen der Verschiebung</li>
                    </ul>
                </li>
            </ul>
            <p class="ml-6 mb-4 text-sm text-gray-600">
                <em>Hinweis:</em> Beim Verschieben werden Start- und Enddatum automatisch angepasst, um den neuen Wochentag zu reflektieren.
            </p>

            <h3 class="text-lg font-bold text-indigo-700 mb-3 mt-5 flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                </svg>
                Nicht zugewiesene Aufgaben
            </h3>
            <ul class="list-disc list-inside space-y-2 mb-4">
                <li><strong>Gelber Bereich oben</strong>: Zeigt alle Aufgaben an, die noch keinem Mitarbeiter zugewiesen sind</li>
                <li><strong>Aufgabenchips</strong>: Jede nicht zugewiesene Aufgabe erscheint als anklickbarer Chip mit:
                    <ul class="list-circle list-inside ml-6 mt-1 space-y-1">
                        <li>Aufgabenname</li>
                        <li>Datumsbereich</li>
                        <li>Priorit√§tssymbol</li>
                    </ul>
                </li>
                <li><strong>Chip anklicken</strong>: √ñffnet einen Dialog, der Details zeigt und die Option bietet, die Aufgabe sich selbst zuzuweisen</li>
            </ul>

            <h3 class="text-lg font-bold text-indigo-700 mb-3 mt-5 flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                </svg>
                Ansichtswechsel
            </h3>
            <ul class="list-disc list-inside space-y-2 mb-4">
                <li><strong>"Zur Listenansicht wechseln" Button</strong>: Wechselt von der Board-Ansicht (Tabelle) zur Listenansicht</li>
                <li><strong>Listenansicht</strong>: Zeigt alle Aufgaben in einer sortierbaren, filtrierbaren Liste mit vollst√§ndigen Details</li>
                <li><strong>"Zur Board-Ansicht wechseln" Button</strong>: Kehrt zur wochenbasierten Tabellenansicht zur√ºck</li>
            </ul>

            <h3 class="text-lg font-bold text-indigo-700 mb-3 mt-5 flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
                </svg>
                Status und Priorit√§t
            </h3>
            <ul class="list-disc list-inside space-y-2 mb-4">
                <li><strong>Status-Badges</strong>:
                    <ul class="list-circle list-inside ml-6 mt-1 space-y-1">
                        <li><span class="px-2 py-0.5 rounded-full text-xs bg-gray-100 text-gray-700 border border-gray-300">‚è± Ausstehend</span> - Aufgabe noch nicht begonnen</li>
                        <li><span class="px-2 py-0.5 rounded-full text-xs bg-blue-100 text-blue-700 border border-blue-300">‚ü≥ In Bearbeitung</span> - Aufgabe wird gerade bearbeitet</li>
                        <li><span class="px-2 py-0.5 rounded-full text-xs bg-green-100 text-green-700 border border-green-300">‚úì Abgeschlossen</span> - Aufgabe fertiggestellt</li>
                    </ul>
                </li>
                <li><strong>Priorit√§tssymbole</strong>:
                    <ul class="list-circle list-inside ml-6 mt-1 space-y-1">
                        <li>üî¥ Rotes Symbol = Hohe Priorit√§t</li>
                        <li>üü° Gelbes Symbol = Mittlere Priorit√§t</li>
                        <li>üü¢ Gr√ºnes Symbol = Niedrige Priorit√§t</li>
                    </ul>
                </li>
            </ul>

            <h3 class="text-lg font-bold text-indigo-700 mb-3 mt-5 flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                Besondere Funktionen
            </h3>
            <ul class="list-disc list-inside space-y-2 mb-4">
                <li><strong>Mehrtagige Aufgaben</strong>: Aufgaben, die sich √ºber mehrere Tage erstrecken, erscheinen in allen relevanten Tageszellen</li>
                <li><strong>Pfeilsymbole</strong>: 
                    <ul class="list-circle list-inside ml-6 mt-1 space-y-1">
                        <li>‚óÄ Linker Pfeil = Aufgabe begann vor der angezeigten Woche</li>
                        <li>‚ñ∂ Rechter Pfeil = Aufgabe endet nach der angezeigten Woche</li>
                    </ul>
                </li>
                <li><strong>Heutige Spalte</strong>: Der aktuelle Tag wird mit einer hellblauen Hintergrundfarbe hervorgehoben</li>
                <li><strong>Responsive Design</strong>: 
                    <ul class="list-circle list-inside ml-6 mt-1 space-y-1">
                        <li>Desktop/Tablet: Tabellenansicht mit allen Tagen nebeneinander</li>
                        <li>Mobile: Kartenbasierte Ansicht, ein Mitarbeiter pro Karte mit zusammenklappbaren Tagen</li>
                    </ul>
                </li>
            </ul>

            <h3 class="text-lg font-bold text-indigo-700 mb-3 mt-5 flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                </svg>
                Tipps & Tricks
            </h3>
            <ul class="list-disc list-inside space-y-2 mb-4">
                <li><strong>Schnellzuweisung</strong>: Erstellen Sie Aufgaben direkt durch Klicken auf eine leere Zelle - Mitarbeiter und Datum werden automatisch vorausgef√ºllt</li>
                <li><strong>Kontextmen√º nutzen</strong>: Rechtsklick auf Aufgaben f√ºr schnellen Zugriff auf h√§ufige Aktionen</li>
                <li><strong>Mehrere Aufgaben pro Tag</strong>: Ein Mitarbeiter kann mehrere Aufgaben an einem Tag haben - alle werden untereinander angezeigt</li>
                <li><strong>Wochen√ºbersicht drucken</strong>: Verwenden Sie die Druckfunktion des Browsers f√ºr eine saubere Aufgaben√ºbersicht</li>
                <li><strong>Filterung</strong>: In der Listenansicht k√∂nnen Sie nach Status, Priorit√§t, Mitarbeiter oder Datum filtern</li>
            </ul>

            <div class="mt-6 p-4 bg-indigo-50 border-l-4 border-indigo-500 rounded">
                <p class="text-sm">
                    <strong>üí° Produktivit√§tstipp:</strong> Aktualisieren Sie den Aufgabenstatus regelm√§√üig, um einen aktuellen √úberblick √ºber den Projektfortschritt zu behalten. 
                    Nutzen Sie die Priorit√§tssymbole, um wichtige Aufgaben hervorzuheben und Ihr Team effektiv zu koordinieren.
                </p>
            </div>
        </div>
    </div>
</div>

<div id="task-content-container" class="overflow-y-auto">
    <!-- Initial view: task board -->
    <div class="task-board-content">
        <%- include('./task_board_content.ejs', { users, tasksByDayAndUser, daysOfWeek, __: __ }) %>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loading-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg p-6 shadow-xl">
        <div class="flex items-center space-x-3">
            <svg class="animate-spin h-8 w-8 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span class="text-gray-700 font-medium"><%= __("LOADING") || "Loading..." %></span>
        </div>
    </div>
</div>

<script>
    window.CREATE_MODAL_TITLE = "<%= createTaskTitle %>";
    window.CURRENT_WEEK_OFFSET = "<%= typeof weekOffset !== 'undefined' ? weekOffset : 0 %>";
    window.taskTranslations = {
        viewSwitch: {
            list: "<%= __('SWITCH_TO_LIST_VIEW') %>",
            board: "<%= __('SWITCH_TO_BOARD_VIEW') %>"
        },
        unassigned: "<%= __('UNASSIGNED') %>",
        cancel: "<%= __('CANCEL') %>",
        dragConfirmTitle: "<%= __('DRAG_CONFIRM_TITLE') %>",
        dragTask: "<%= __('DRAG_TASK') %>",
        dragUser: "<%= __('DRAG_USER') %>",
        dragStartDate: "<%= __('DRAG_START_DATE') %>",
        dragEndDate: "<%= __('DRAG_END_DATE') %>",
        dragConfirmButton: "<%= __('DRAG_CONFIRM_BUTTON') %>",
        dragMoving: "<%= __('DRAG_MOVING') %>",
        contextMenuChangePriority: "<%= __('CONTEXT_MENU_CHANGE_PRIORITY') %>",
        contextMenuDeleteTask: "<%= __('CONTEXT_MENU_DELETE_TASK') %>",
        contextMenuPriorityHigh: "<%= __('CONTEXT_MENU_PRIORITY_HIGH') %>",
        contextMenuPriorityMedium: "<%= __('CONTEXT_MENU_PRIORITY_MEDIUM') %>",
        contextMenuPriorityLow: "<%= __('CONTEXT_MENU_PRIORITY_LOW') %>",
        confirmDeleteTask: "<%= __('CONFIRM_DELETE_TASK') %>",
        unassignedTaskDetails: "<%= __('UNASSIGNED_TASK_DETAILS') %>",
        assignToMe: "<%= __('ASSIGN_TO_ME') %>",
        assigning: "<%= __('ASSIGNING') %>",
        assignToYourselfMessage: "<%= __('ASSIGN_TO_YOURSELF_MESSAGE') %>",
        dateRange: "<%= __('DATE_RANGE') %>"
    };

    // Manual toggle functionality
    document.addEventListener('DOMContentLoaded', function() {
        const manualToggle = document.getElementById('manual-toggle');
        const manualContent = document.getElementById('manual-content');
        const manualChevron = document.getElementById('manual-chevron');
        
        if (manualToggle && manualContent && manualChevron) {
            manualToggle.addEventListener('click', function() {
                const isHidden = manualContent.classList.contains('hidden');
                
                if (isHidden) {
                    manualContent.classList.remove('hidden');
                    manualChevron.style.transform = 'rotate(180deg)';
                } else {
                    manualContent.classList.add('hidden');
                    manualChevron.style.transform = 'rotate(0deg)';
                }
            });
        }
    });
</script>

<script src="/js/task/task-combined-script.js"></script>
