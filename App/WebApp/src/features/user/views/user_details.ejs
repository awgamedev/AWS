<div class="bg-white shadow overflow-hidden sm:rounded-lg">
    <div class="px-4 py-5 sm:px-6">
        <div class="flex items-center justify-between gap-4">
            <h3 class="text-lg leading-6 font-medium text-gray-900">
                <%= __('USER_DETAILS_HEADER') %>
            </h3>
            <a href="/user/list" class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                <span class="fas fa-arrow-left mr-2"></span>
                <%= __('BACK_TO_LIST_BUTTON') || __('USER_LIST_TITLE') %>
            </a>
        </div>
        <p class="mt-1 max-w-2xl text-sm text-gray-500">
            <%= __('USER_DETAILS_DESCRIPTION') %>
        </p>
    </div>

    <form action="/user/details/<%= user._id %>" method="POST" class="border-t border-gray-200">
        <div class="px-4 py-5 sm:p-6">
            <!-- User Information Section -->
            <div class="mb-6">
                <h4 class="text-md font-semibold text-gray-800 mb-4"><%= __('USER_INFO_SECTION') %></h4>
                <dl class="grid grid-cols-1 gap-x-4 gap-y-6 sm:grid-cols-2">
                    <!-- Username -->
                    <div class="sm:col-span-1">
                        <dt class="text-sm font-medium text-gray-500">
                            <%= __('USERNAME_LABEL') %>
                        </dt>
                        <dd class="mt-1">
                            <input type="text" 
                                   name="username" 
                                   value="<%= user.username %>" 
                                   class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm <%= errors.username ? 'border-red-500' : '' %>"
                                   required>
                            <% if (errors.username) { %>
                                <p class="mt-1 text-sm text-red-600"><%= errors.username %></p>
                            <% } %>
                        </dd>
                    </div>

                    <!-- Email -->
                    <div class="sm:col-span-1">
                        <dt class="text-sm font-medium text-gray-500">
                            <%= __('EMAIL_LABEL') %>
                        </dt>
                        <dd class="mt-1">
                            <input type="email" 
                                   name="email" 
                                   value="<%= user.email %>" 
                                   class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm <%= errors.email ? 'border-red-500' : '' %>"
                                   required>
                            <% if (errors.email) { %>
                                <p class="mt-1 text-sm text-red-600"><%= errors.email %></p>
                            <% } %>
                        </dd>
                    </div>

                    <!-- Role -->
                    <div class="sm:col-span-1">
                        <dt class="text-sm font-medium text-gray-500">
                            <%= __('ROLE_LABEL') %>
                        </dt>
                        <dd class="mt-1">
                            <select name="role" 
                                    class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                <option value="user" <%= user.role === 'user' ? 'selected' : '' %>><%= __('ROLE_USER') %></option>
                                <option value="admin" <%= user.role === 'admin' ? 'selected' : '' %>><%= __('ROLE_ADMIN') %></option>
                            </select>
                        </dd>
                    </div>

                    <!-- Password (optional) -->
                    <div class="sm:col-span-1">
                        <dt class="text-sm font-medium text-gray-500">
                            <%= __('PASSWORD_LABEL') %>
                        </dt>
                        <dd class="mt-1">
                            <input type="password" 
                                   name="password" 
                                   placeholder="<%= __('PASSWORD_PLACEHOLDER') %>"
                                   class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm <%= errors.password ? 'border-red-500' : '' %>">
                            <p class="mt-1 text-xs text-gray-500"><%= __('PASSWORD_OPTIONAL_NOTE') %></p>
                            <% if (errors.password) { %>
                                <p class="mt-1 text-sm text-red-600"><%= errors.password %></p>
                            <% } %>
                        </dd>
                    </div>

                    <!-- Created At -->
                    <div class="sm:col-span-1">
                        <dt class="text-sm font-medium text-gray-500">
                            <%= __('CREATED_AT_LABEL') %>
                        </dt>
                        <dd class="mt-1 text-sm text-gray-900">
                            <%= new Date(user.createdAt).toLocaleDateString("de-DE") %>
                        </dd>
                    </div>

                    <!-- Updated At -->
                    <div class="sm:col-span-1">
                        <dt class="text-sm font-medium text-gray-500">
                            <%= __('UPDATED_AT_LABEL') %>
                        </dt>
                        <dd class="mt-1 text-sm text-gray-900">
                            <%= new Date(user.updatedAt).toLocaleDateString("de-DE") %>
                        </dd>
                    </div>
                </dl>
            </div>

            <!-- User Profile Section -->
            <div class="border-t border-gray-200 pt-6">
                <h4 class="text-md font-semibold text-gray-800 mb-4"><%= __('USER_PROFILE_SECTION') %></h4>
                <dl class="grid grid-cols-1 gap-x-4 gap-y-6 sm:grid-cols-2">
                    <!-- Profile Picture -->
                    <div class="sm:col-span-2">
                        <dt class="text-sm font-medium text-gray-500 mb-2">
                            <%= __('PROFILE_PICTURE_LABEL') %>
                        </dt>
                        <dd>
                            <div class="flex items-start gap-4">
                                <div class="relative">
                                    <div id="profile-avatar" class="w-32 h-32 rounded-full border-4 border-gray-300 shadow-lg bg-gray-100 flex items-center justify-center overflow-hidden">
                                        <% if (userProfile && userProfile.profilePictureBase64) { %>
                                            <img src="<%= userProfile.profilePictureBase64 %>" alt="<%= __('PROFILE_PICTURE_ALT') %>" class="w-full h-full object-cover">
                                        <% } else { %>
                                            <span class="text-4xl font-bold text-gray-400"><%= user.username.substring(0, 2).toUpperCase() %></span>
                                        <% } %>
                                    </div>
                                    <input type="file" id="avatar-input" accept="image/*" class="hidden">
                                </div>
                                <div class="flex flex-col gap-2 mt-2">
                                    <button type="button" id="upload-avatar-btn" class="inline-flex items-center px-3 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition">
                                        <i class="fas fa-camera mr-2"></i>
                                        <%= __('UPLOAD_PICTURE_BUTTON') || 'Upload Picture' %>
                                    </button>
                                    <% if (userProfile && userProfile.profilePictureBase64) { %>
                                    <button type="button" id="remove-avatar-btn" class="inline-flex items-center px-3 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition">
                                        <i class="fas fa-trash mr-2"></i>
                                        <%= __('REMOVE_PROFILE_PICTURE') %>
                                    </button>
                                    <% } %>
                                </div>
                            </div>
                            <p class="mt-2 text-xs text-gray-500"><%= __('PROFILE_PICTURE_ADMIN_NOTE') || 'Profile picture changes are saved immediately' %></p>
                        </dd>
                    </div>

                    <!-- Pause Time -->
                    <div class="sm:col-span-1">
                        <dt class="text-sm font-medium text-gray-500">
                            <%= __('PAUSE_TIME_LABEL') %>
                        </dt>
                        <dd class="mt-1">
                            <input type="number" 
                                   name="pauseInMinutesPerDay" 
                                   value="<%= userProfile && userProfile.pauseInMinutesPerDay !== null ? userProfile.pauseInMinutesPerDay : '' %>" 
                                   placeholder="<%= __('PAUSE_TIME_PLACEHOLDER') %>"
                                   min="0"
                                   class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm <%= errors.pauseInMinutesPerDay ? 'border-red-500' : '' %>">
                            <p class="mt-1 text-xs text-gray-500"><%= __('PAUSE_TIME_HINT') %></p>
                            <% if (errors.pauseInMinutesPerDay) { %>
                                <p class="mt-1 text-sm text-red-600"><%= errors.pauseInMinutesPerDay %></p>
                            <% } %>
                        </dd>
                    </div>

                    <!-- Vacation Days -->
                    <div class="sm:col-span-1">
                        <dt class="text-sm font-medium text-gray-500">
                            <%= __('VACATION_DAYS_LABEL') %>
                        </dt>
                        <dd class="mt-1">
                            <input type="number" 
                                   name="vacationDaysPerYear" 
                                   value="<%= userProfile && userProfile.vacationDaysPerYear !== null ? userProfile.vacationDaysPerYear : 20 %>" 
                                   min="0"
                                   class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm <%= errors.vacationDaysPerYear ? 'border-red-500' : '' %>"
                                   required>
                            <p class="mt-1 text-xs text-gray-500"><%= __('VACATION_DAYS_HINT') %></p>
                            <% if (errors.vacationDaysPerYear) { %>
                                <p class="mt-1 text-sm text-red-600"><%= errors.vacationDaysPerYear %></p>
                            <% } %>
                        </dd>
                    </div>
                </dl>
            </div>
        </div>

        <!-- Form Actions -->
        <div class="px-4 py-3 bg-gray-50 text-right sm:px-6 flex gap-2 items-center justify-end">
            <% if (user && user._id && userRole === 'admin') { %>
            <button id="create-cert-btn" type="button" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
            <i class="fas fa-certificate mr-2"></i> <%= __('CREATE_CERTIFICATE_BUTTON') || 'Create Certificate' %>
            </button>
            <% } %>
            <button type="submit" 
                class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
            <%= __('SAVE_BUTTON') %>
            </button>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const uploadBtn = document.getElementById('upload-avatar-btn');
    const removeBtn = document.getElementById('remove-avatar-btn');
    const avatarInput = document.getElementById('avatar-input');
    const profileAvatar = document.getElementById('profile-avatar');
    const userId = '<%= user._id %>';

    // Upload button click
    if (uploadBtn) {
        uploadBtn.addEventListener('click', function() {
            avatarInput.click();
        });
    }

    // Handle file selection
    if (avatarInput) {
        avatarInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            // Validate file type
            if (!file.type.startsWith('image/')) {
                alert('Please select an image file');
                return;
            }

            // Read and convert to base64
            const reader = new FileReader();
            reader.onload = function(event) {
                const imageBase64 = event.target.result;

                // Send to server
                fetch('profile/upload-picture', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ imageBase64: imageBase64, userId: userId })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Update the avatar display
                        profileAvatar.innerHTML = `<img src="${imageBase64}" alt="Profile Picture" class="w-full h-full object-cover">`;
                        
                        // Show remove button if not already visible
                        if (removeBtn) {
                            removeBtn.style.display = 'inline-flex';
                        } else {
                            location.reload(); // Reload to show remove button
                        }
                        
                        alert(data.msg || 'Profile picture updated successfully');
                    } else {
                        alert(data.msg || 'Error uploading profile picture');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Network error uploading profile picture');
                });
            };
            reader.readAsDataURL(file);
        });
    }

    // Remove button click
    if (removeBtn) {
        removeBtn.addEventListener('click', function() {
            if (!confirm('Are you sure you want to remove the profile picture?')) {
                return;
            }

            fetch('profile/remove-picture', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ userId: userId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update the avatar display with initials
                    const username = '<%= user.username %>';
                    const initials = username.substring(0, 2).toUpperCase();
                    profileAvatar.innerHTML = `<span class="text-4xl font-bold text-gray-400">${initials}</span>`;
                    
                    // Hide remove button
                    removeBtn.style.display = 'none';
                    
                    alert(data.msg || 'Profile picture removed successfully');
                } else {
                    alert(data.msg || 'Error removing profile picture');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Network error removing profile picture');
            });
        });
    }
});
</script>
<script>
// Intercept cert creation button to navigate to certificate info page
document.addEventListener('DOMContentLoaded', function() {
    var certBtn = document.getElementById('create-cert-btn');
    if (certBtn) {
        certBtn.addEventListener('click', function(e) {
            e.preventDefault();
            var userId = '<%= user._id %>';
            var url = 'user/' + userId + '/create-cert';
            
            // Show loading state
            certBtn.disabled = true;
            certBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Erstelle Zertifikat...';
            
            fetch(url, {
                method: 'POST',
                headers: { 
                    'X-Requested-With': 'XMLHttpRequest',
                    'Content-Type': 'application/json'
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.ok && data.redirect) {
                    // Navigate to certificate info page
                    window.location.href = data.redirect;
                } else {
                    throw new Error(data.msg || 'Failed to generate certificate');
                }
            })
            .catch(err => {
                alert('Zertifikatserstellung fehlgeschlagen: ' + err.message);
                // Reset button state
                certBtn.disabled = false;
                certBtn.innerHTML = '<i class="fas fa-certificate mr-2"></i> <%= __("CREATE_CERTIFICATE_BUTTON") || "Create Certificate" %>';
            });
        });
    }
});
</script>
