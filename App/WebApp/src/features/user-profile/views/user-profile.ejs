<div class="max-w-5xl mx-auto space-y-6">
  <!-- Page Header -->
  <section class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
    <div>
      <h1 class="text-2xl font-bold text-gray-800"><%= __('USER_PROFILE_TITLE') %></h1>
      <p class="text-sm text-gray-500 mt-1"><%= __('USER_PROFILE_SUBTITLE') %></p>
    </div>
  </section>

  <!-- Profile Card -->
  <div class="bg-white rounded-xl shadow border border-gray-200 overflow-hidden">
    <!-- Profile Header with Avatar -->
    <div class="bg-gradient-to-r from-indigo-500 to-purple-600 h-32"></div>
    <div class="px-6 pb-6">
      <div class="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-4 -mt-16">
        <div class="flex items-end gap-4">
          <!-- Avatar -->
          <div class="relative">
            <div class="w-32 h-32 rounded-full border-4 border-white shadow-lg bg-gray-100 flex items-center justify-center overflow-hidden">
              <% if (userProfile && userProfile.profilePictureBase64) { %>
                <img src="<%= userProfile.profilePictureBase64 %>" alt="Profile Picture" class="w-full h-full object-cover">
              <% } else { %>
                <span class="text-4xl font-bold text-gray-400"><%= user.username.substring(0, 2).toUpperCase() %></span>
              <% } %>
            </div>
            <button id="upload-avatar-btn" class="absolute bottom-0 right-0 bg-indigo-600 hover:bg-indigo-700 text-white rounded-full p-2 shadow-lg transition">
              <i class="fas fa-camera"></i>
            </button>
            <input type="file" id="avatar-input" accept="image/*" class="hidden">
          </div>
          
          <!-- User Info -->
          <div class="mb-2">
            <h2 class="text-2xl font-bold text-white"><%= user.username %></h2>
            <p class="text-sm text-gray-500"><%= user.email %></p>
            <span class="inline-block mt-1 px-3 py-1 text-xs font-semibold rounded-full <%= user.role === 'admin' ? 'bg-purple-100 text-purple-800' : 'bg-blue-100 text-blue-800' %>">
              <%= user.role === 'admin' ? 'Administrator' : 'User' %>
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Profile Details Grid -->
  <div class="grid gap-6 md:grid-cols-2">
    <!-- Account Information -->
    <div class="bg-white rounded-xl shadow border border-gray-200 p-6">
      <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
        <i class="fas fa-user-circle text-indigo-500"></i>
        <%= __('ACCOUNT_INFORMATION') %>
      </h3>
      <div class="space-y-3">
        <div class="flex justify-between py-2 border-b border-gray-100">
          <span class="text-sm text-gray-600"><%= __('USERNAME') %></span>
          <span class="text-sm font-medium text-gray-800"><%= user.username %></span>
        </div>
        <div class="flex justify-between py-2 border-b border-gray-100">
          <span class="text-sm text-gray-600"><%= __('EMAIL') %></span>
          <span class="text-sm font-medium text-gray-800"><%= user.email %></span>
        </div>
        <div class="flex justify-between py-2 border-b border-gray-100">
          <span class="text-sm text-gray-600"><%= __('ROLE') %></span>
          <span class="text-sm font-medium text-gray-800"><%= user.role %></span>
        </div>
        <div class="flex justify-between py-2">
          <span class="text-sm text-gray-600"><%= __('MEMBER_SINCE') %></span>
            <span class="text-sm font-medium text-gray-800"><%= new Date(user.createdAt).toLocaleDateString('de-DE') %></span>
        </div>
      </div>
    </div>

    <!-- Work Settings -->
    <div class="bg-white rounded-xl shadow border border-gray-200 p-6">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold text-gray-800 flex items-center gap-2">
          <i class="fas fa-briefcase text-indigo-500"></i>
          <%= __('WORK_SETTINGS') || 'Work Settings' %>
        </h3>
        <% if (user.role === 'admin') { %>
          <button id="edit-profile-btn" class="px-3 py-1.5 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-xs font-medium shadow transition flex items-center gap-1.5">
            <i class="fas fa-edit"></i>
            <%= __('EDIT') %>
          </button>
        <% } %>
      </div>
      <div class="space-y-3">
        <div class="flex justify-between py-2 border-b border-gray-100">
          <span class="text-sm text-gray-600"><%= __('DAILY_PAUSE') || 'Daily Pause' %></span>
          <span class="text-sm font-medium text-gray-800">
            <%= userProfile && userProfile.pauseInMinutesPerDay ? userProfile.pauseInMinutesPerDay + ' min' : '-' %>
          </span>
        </div>
        <div class="py-2 border-b border-gray-100">
          <div class="flex justify-between mb-1">
            <span class="text-sm text-gray-600"><%= __('VACATION_DAYS') %></span>
            <span class="text-sm font-medium text-gray-800">
              <%= userProfile && userProfile.vacationDaysPerYear ? userProfile.vacationDaysPerYear : 20 %> <%= __('DAYS_PER_YEAR') || 'days/year' %>
            </span>
          </div>
          <div class="flex items-center gap-2 mt-2">
            <div class="flex-1 bg-gray-200 rounded-full h-2 overflow-hidden">
              <div class="bg-green-500 h-full rounded-full" style="width: <%= Math.max(0, Math.min(100, (vacationDaysRemaining / (userProfile.vacationDaysPerYear || 20)) * 100)) %>%"></div>
            </div>
            <span class="text-xs font-semibold <%= vacationDaysRemaining > 5 ? 'text-green-600' : vacationDaysRemaining > 2 ? 'text-yellow-600' : 'text-red-600' %>">
              <%= vacationDaysRemaining %> <%= __('REMAINING') || 'remaining' %>
            </span>
          </div>
        </div>
        <div class="py-2">
          <div class="flex justify-between py-2">
            <span class="text-sm text-gray-600"><%= __('SICK_DAYS_TAKEN') || 'Sick Days Taken' %></span>
            <span class="text-sm font-medium text-gray-800">
              <%= typeof sickDaysUsed !== 'undefined' ? sickDaysUsed : 0 %>
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Reports & Vacation Widget -->
  <div class="mt-6 space-y-6" id="user-reports-widget">
    <!-- Vacation Days Info Card (replicated from report_user.ejs) -->
    <div class="bg-white rounded-lg shadow border border-gray-200 p-4">
      <h3 class="text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">
        <i class="fas fa-umbrella-beach text-indigo-500"></i>
        <%= __('VACATION_DAYS') || 'Vacation Days' %>
      </h3>
      <div class="space-y-2 mb-3">
        <div class="flex justify-between items-center text-sm">
          <span class="text-gray-600"><%= __('TOTAL') || 'Total' %>:</span>
          <span class="font-medium text-gray-800"><%= userProfile && userProfile.vacationDaysPerYear ? userProfile.vacationDaysPerYear : 20 %> <%= __('DAYS') %></span>
        </div>
        <% const totalVacation = (userProfile && userProfile.vacationDaysPerYear) ? userProfile.vacationDaysPerYear : 20; %>
        <% const usedVacation = typeof vacationDaysUsed !== 'undefined' ? vacationDaysUsed : (totalVacation - vacationDaysRemaining); %>
        <% const remainingVacation = Math.max(0, totalVacation - usedVacation); %>
        <% const barColorClass = remainingVacation > 5 ? 'bg-green-500' : (remainingVacation > 2 ? 'bg-yellow-500' : 'bg-red-500'); %>
        <% const widthPercent = Math.max(0, Math.min(100, (usedVacation / totalVacation) * 100)); %>
        <div class="flex items-center gap-2" aria-label="Urlaubstage Fortschritt">
          <div class="flex-1 bg-gray-200 rounded-full h-2 overflow-hidden" aria-hidden="true">
            <div class="h-full rounded-full <%= barColorClass %>" data-progress-bar data-width="<%= widthPercent %>"></div>
          </div>
          <span class="text-xs font-semibold text-gray-700">
            <%= usedVacation %>/<%= totalVacation %> <%= __('USED') || 'genutzt' %> · <%= remainingVacation %> <%= __('REMAINING') %>
          </span>
        </div>
      </div>

      <div class="relative flex mb-4 gap-2">
        <input type="text" id="reportSearch" placeholder="<%= __('REPORT_SEARCH_PLACEHOLDER') %>" class="w-full px-4 py-2 border border-gray-300 shadow-sm rounded-l-md focus:ring-indigo-500 focus:border-indigo-500 z-10">
        <button id="open-report-modal" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 rounded-r-md -ml-px z-20">
          <span class="fas fa-plus"></span>
        </button>
      </div>
      <div class="shadow overflow-hidden border-b border-gray-200 sm:rounded-lg relative max-h-96 overflow-y-auto overflow-x-auto">
        <table id="reportTable" class="min-w-full divide-y divide-gray-200 responsive-table actions-last">
          <thead class="bg-gray-50 sticky top-0 z-10">
            <tr>
              <th data-column="type" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer">Typ</th>
              <th data-column="start" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer">Start</th>
              <th data-column="end" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer">Ende</th>
              <th data-column="status" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer">Status</th>
              <th data-column="description" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer">Beschreibung</th>
              <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider"></th>
            </tr>
          </thead>
          <tbody id="reportTableBody" class="bg-white divide-y divide-gray-200">
            <% const reportItems = (typeof items !== 'undefined' && Array.isArray(items))
              ? items
              : ((typeof reports !== 'undefined' && Array.isArray(reports)) ? reports : []); %>
            <% reportItems.forEach(r => { %>
              <tr data-id="<%= r._id %>" data-type="<%= r.type %>" data-start="<%= new Date(r.startDate).toLocaleDateString('de-DE') %>" data-end="<%= new Date(r.endDate).toLocaleDateString('de-DE') %>" data-status="<%= r.status %>" data-description="<%= r.description || '' %>">
                <td class="px-6 py-3 text-left text-sm font-medium text-gray-900" data-label="Typ"><%= __('REPORT_TYPE_' + r.type.toUpperCase()) %></td>
                <td class="px-6 py-3 text-left text-sm font-medium text-gray-900" data-label="Start"><%= new Date(r.startDate).toLocaleDateString('de-DE') %></td>
                <td class="px-6 py-3 text-left text-sm font-medium text-gray-900" data-label="Ende"><%= new Date(r.endDate).toLocaleDateString('de-DE') %></td>
                <td class="px-6 py-3 text-left text-sm font-medium text-gray-900" data-label="Status"><%= __('REPORT_STATUS_' + r.status.toUpperCase()) %></td>
                <td class="px-6 py-3 text-left text-sm font-medium text-gray-900" data-label="Beschreibung"><%= r.description || '' %></td>
                <td class="px-6 py-3 text-right">
                  <div class="flex justify-end gap-2">
                    <% if (r.status === 'pending') { %>
                      <button 
                        class="edit-report-btn inline-flex items-center px-3 py-2 text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 transition-colors"
                        data-id="<%= r._id %>"
                        data-type="<%= r.type %>"
                        data-start="<%= new Date(r.startDate).toISOString().substring(0,10) %>"
                        data-end="<%= new Date(r.endDate).toISOString().substring(0,10) %>"
                        data-description="<%= r.description || '' %>">
                        <span>✏️</span>
                        <span class="ml-1"><%= __('EDIT_BUTTON') %></span>
                      </button>
                    <% } %>
                  </div>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Edit Profile Modal -->
  <div id="edit-profile-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
      <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex items-center justify-between">
        <h3 class="text-xl font-semibold text-gray-800"><%= __('EDIT_WORK_SETTINGS')  %></h3>
        <button id="close-modal-btn" class="text-gray-400 hover:text-gray-600 transition">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>
      
      <form id="edit-profile-form" class="p-6 space-y-4">
        <!-- Work Settings Section -->
        <div class="space-y-4">
          <h4 class="font-medium text-gray-700 border-b pb-2"><%= __('WORK_SETTINGS') %></h4>
          
          <div>
            <label for="pauseInMinutesPerDay" class="block text-sm font-medium text-gray-700 mb-1">
              <%= __('DAILY_PAUSE') %>
            </label>
            <input 
              type="number" 
              id="pauseInMinutesPerDay" 
              name="pauseInMinutesPerDay" 
              value="<%= userProfile && userProfile.pauseInMinutesPerDay ? userProfile.pauseInMinutesPerDay : '' %>"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
              min="0"
              max="480"
            >
            <p class="mt-1 text-xs text-gray-500"><%= __('DAILY_PAUSE_HELP') %></p>
          </div>

          <div>
            <label for="vacationDaysPerYear" class="block text-sm font-medium text-gray-700 mb-1">
              <%= __('VACATION_DAYS') %>
            </label>
            <input 
              type="number" 
              id="vacationDaysPerYear" 
              name="vacationDaysPerYear" 
              value="<%= userProfile && userProfile.vacationDaysPerYear ? userProfile.vacationDaysPerYear : 20 %>"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
              min="0"
              max="365"
              required
            >
          </div>
        </div>

        <!-- Error Display -->
        <div id="form-errors" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm"></div>

        <!-- Form Actions -->
        <div class="flex gap-3 pt-4 border-t">
          <button 
            type="submit" 
            class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg font-medium transition"
          >
            <%= __('SAVE_CHANGES') %>
          </button>
          <button 
            type="button" 
            id="cancel-modal-btn"
            class="px-4 py-2 border border-gray-300 hover:bg-gray-50 text-gray-700 rounded-lg font-medium transition"
          >
            <%= __('CANCEL') %>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
<script>
  // Translation data for client-side use (reports widget)
  window.reportTranslations = {
    types: {
      vacation: "<%= __('REPORT_TYPE_VACATION') %>",
      illness: "<%= __('REPORT_TYPE_ILLNESS') %>"
    },
    statuses: {
      pending: "<%= __('REPORT_STATUS_PENDING') %>",
      approved: "<%= __('REPORT_STATUS_APPROVED') %>",
      rejected: "<%= __('REPORT_STATUS_REJECTED') %>"
    }
  };
  // Apply dynamic widths to progress bars after DOM loads
  document.querySelectorAll('[data-progress-bar]').forEach(el => {
    const w = el.getAttribute('data-width');
    if (w !== null) {
      el.style.width = w + '%';
    }
  });
</script>
<script src="/js/report/report-user-script.js"></script>
<script src="/js/user/user-profile-script.js"></script>