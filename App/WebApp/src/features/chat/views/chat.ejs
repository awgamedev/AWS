<div class="chat-container" data-current-user-id="<%= currentUserId %>" data-user-role="<%= userRole %>">
    <!-- Left Sidebar: User List and Groups -->
    <div class="chat-sidebar">
        <!-- Header with Create Group Button -->
        <div class="chat-sidebar-header">
            <h2 class="chat-sidebar-title"><%= __('CHAT_SIDEBAR_TITLE') %></h2>
            <button id="createGroupBtn" class="btn-create-group" title="<%= __('CREATE_GROUP') %>">
                <i class="fas fa-plus"></i>
                <i class="fas fa-users"></i>
            </button>
        </div>

        <!-- Search Bar -->
        <div class="chat-search-container">
            <input type="text" id="chatSearch" class="chat-search-input" placeholder="<%= __('SEARCH_CHATS') %>">
        </div>

        <!-- Chat List -->
        <div class="chat-list" id="chatList">
            <!-- Existing Chats will be rendered here -->
            <% if (userChats && userChats.length > 0) { %>
                <% userChats.forEach(chat => { %>
                    <div class="chat-item" data-chat-id="<%= chat._id %>" data-chat-type="<%= chat.type %>" data-creator-id="<%= chat.creatorId._id %>">
                        <div class="chat-item-avatar w-8 h-8 rounded-full flex items-center justify-center text-white font-bold text-sm shadow-lg ring-2 ring-indigo-300 overflow-hidden <%= chat.type === 'group' ? 'bg-indigo-400' : 'bg-indigo-600' %>">
                            <% if (chat.type === 'group') { %>
                                <i class="fas fa-users"></i>
                            <% } else { %>
                                <% const otherUser = chat.participants.find(p => p._id.toString() !== currentUserId.toString());
                                   const otherProfile = otherUser && userProfiles && userProfiles[otherUser._id.toString()]; %>
                                <% if (otherProfile && otherProfile.profilePictureBase64) { %>
                                    <img src="<%= otherProfile.profilePictureBase64 %>" alt="Avatar" class="w-full h-full object-cover" />
                                <% } else { %>
                                    <%= otherUser ? otherUser.username.substring(0, 2).toUpperCase() : 'U' %>
                                <% } %>
                            <% } %>
                        </div>
                        <div class="chat-item-content">
                            <div class="chat-item-header">
                                <span class="chat-item-name">
                                    <% if (chat.type === 'group') { %>
                                        <%= chat.name %>
                                    <% } else { %>
                                        <% const otherUser = chat.participants.find(p => p._id.toString() !== currentUserId.toString()); %>
                                        <%= otherUser ? otherUser.username : 'User' %>
                                    <% } %>
                                </span>
                                <% if (chat.type === 'group' && (chat.creatorId._id.toString() === currentUserId.toString() || userRole === 'admin')) { %>
                                    <button class="btn-delete-chat" data-chat-id="<%= chat._id %>" title="<%= __('DELETE_CHAT') %>">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                <% } %>
                            </div>
                            <% if (chat.lastMessage) { 
                                const _raw = chat.lastMessage.content || ''; 
                                const _text = _raw.replace(/<[^>]*>/g, ''); 
                                const _snippet = _text.substring(0, 50); 
                            %>
                                <p class="chat-item-preview"><%= _snippet %><%= _text.length > 50 ? '...' : '' %></p>
                            <% } %>
                        </div>
                    </div>
                <% }); %>
            <% } else { %>
                <div class="no-chats-message">
                    <i class="fas fa-comments"></i>
                    <p><%= __('NO_CHATS_AVAILABLE') %></p>
                </div>
            <% } %>
        </div>

        <!-- User List Section (Collapsible) -->
        <div class="user-list-section collapsed" id="userListSection">
            <h3 class="user-list-title" style="display:flex;align-items:center;justify-content:space-between;cursor:pointer;" onclick="toggleUserListSection()">
                Benutzer
                <button id="userListToggleBtn" class="user-list-toggle-btn" style="background:none;border:none;outline:none;cursor:pointer;padding:0 0 0 8px;">
                    <i id="userListToggleIcon" class="fas fa-chevron-down" style="transition:transform 0.2s;"></i>
                </button>
            </h3>
            <div class="user-list" id="userList" style="display:none;">
                <% allUsers.forEach(user => { %>
                    <% if (user._id.toString() !== currentUserId.toString()) { %>
                        <div class="user-item" data-user-id="<%= user._id %>">
                            <div class="user-item-avatar w-9 h-9 rounded-full flex items-center justify-center text-white font-bold text-sm shadow-lg ring-2 ring-indigo-300 overflow-hidden bg-indigo-600">
                                <% const profile = userProfiles && userProfiles[user._id.toString()]; %>
                                <% if (profile && profile.profilePictureBase64) { %>
                                    <img src="<%= profile.profilePictureBase64 %>" alt="Avatar" class="w-full h-full object-cover" />
                                <% } else { %>
                                    <%= user.username.substring(0, 2).toUpperCase() %>
                                <% } %>
                            </div>
                            <div class="user-item-content">
                                <span class="user-item-name"><%= user.username %></span>
                                <% if (user.role === 'admin') { %>
                                    <span class="user-badge">Admin</span>
                                <% } %>
                            </div>
                        </div>
                    <% } %>
                <% }); %>
            </div>
        </div>
    </div>

    <!-- Right Side: Chat Area -->
    <div class="chat-main" id="chatMain">
        <!-- Welcome Screen (shown when no chat is selected) -->
        <div id="welcomeScreen" class="chat-welcome">
            <i class="fas fa-comments"></i>
              <h2><%= __('CHAT_WELCOME_TITLE') %></h2>
              <p><%= __('CHAT_WELCOME_SUBTITLE') %></p>
        </div>

        <!-- Chat Window (hidden by default) -->
        <div id="chatWindow" class="chat-window" style="display: none;">
            <!-- Chat Header -->
            <div class="chat-header">
                <button id="backToListBtn" class="btn-back-mobile" style="display:none;" title="Zurück zur Liste">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <div class="chat-header-info">
                        <h3 id="chatTitle"><%= __('CHAT_HEADER_TITLE') %></h3>
                    <p id="chatSubtitle"></p>
                </div>
                <div class="chat-header-actions">
                    <button id="renameGroupBtn" class="btn-rename-chat" style="display:none;" title="<%= __('CHAT_HEADER_RENAME') %>">
                        <i class="fas fa-pen"></i>
                    </button>
                    <button id="closeChatBtn" class="btn-close-chat" title="<%= __('CHAT_HEADER_CLOSE') %>">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>


            <!-- Messages Area -->
            <div class="chat-messages" id="chatMessages">
                <!-- Messages will be dynamically inserted here -->
            </div>
            <!-- Typing Indicator -->
            <div id="typingIndicator" class="chat-typing-indicator" style="display:none;"></div>

            <!-- Message Input (Simple default, Rich on toggle) -->
            <div class="chat-input-container simple-mode">
                <div id="toastContainer" aria-live="polite"></div>
                <!-- Simple row: input + toggle + send -->
                <div class="chat-simple-row" id="simpleRow">
                    <input type="text" id="simpleMessageInput" class="simple-chat-input" placeholder="<%= __('CHAT_SIMPLE_INPUT_PLACEHOLDER') %>" autocomplete="off" />
                    <button id="editorModeToggle" class="btn-toggle-mode" title="Rich-Editor öffnen">
                        <i class="fas fa-expand"></i>
                    </button>
                    <button id="sendMessageBtn" class="btn-send-message" title="<%= __('CHAT_SEND_TITLE') %>">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
                <!-- Rich editor wrapper (hidden initially) -->
                <div class="chat-editor-wrapper" style="display:none;">
                    <div id="toolbar" class="chat-toolbar">
                        <button class="ql-bold" title="Fett"></button>
                        <button class="ql-italic" title="Kursiv"></button>
                        <button class="ql-underline" title="Unterstrichen"></button>
                        <button class="ql-strike" title="Durchgestrichen"></button>
                        <button class="ql-list" value="ordered" title="Nummerierte Liste"></button>
                        <button class="ql-list" value="bullet" title="Aufzählungsliste"></button>
                        <select class="ql-size" title="Schriftgröße">
                            <option value="small">Klein</option>
                            <option selected>Normal</option>
                            <option value="large">Groß</option>
                            <option value="huge">Sehr Groß</option>
                        </select>
                        <select class="ql-color" title="Textfarbe"></select>
                        <select class="ql-background" title="Hintergrundfarbe"></select>
                        <button class="ql-link" title="Link einfügen"></button>
                        <button class="ql-image" title="Bild hochladen"></button>
                        <button id="fullscreenBtn" class="ql-custom" title="Vollbild">
                            <i class="fas fa-expand"></i>
                        </button>
                    </div>
                    <div id="messageInput" class="chat-input-editor"></div>
                    <div class="chat-input-send-wrapper">
                        <button id="editorModeToggleRich" class="btn-toggle-mode" title="<%= __('CHAT_SIMPLE_TOGGLE_TITLE') %>">
                            <i class="fas fa-compress"></i>
                        </button>
                        <button id="sendMessageBtnRich" class="btn-send-message" title="<%= __('CHAT_SEND_TITLE') %>">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Renaming Group -->
<div id="renameGroupModal" class="modal-overlay" style="display:none;">
  <div class="modal-content">
    <div class="modal-header">
        <h3><%= __('CHAT_GROUP_RENAME_TITLE') %></h3>
            <button class="modal-close" onclick="closeRenameGroupModal()" title="<%= __('CHAT_HEADER_CLOSE') %>"><i class="fas fa-times"></i></button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label for="renameGroupInput"><%= __('CHAT_GROUP_RENAME_LABEL') %></label>
        <input type="text" id="renameGroupInput" class="form-input" placeholder="<%= __('CHAT_GROUP_RENAME_PLACEHOLDER') %>" />
      </div>
    </div>
    <div class="modal-footer">
    <button class="btn-secondary" onclick="closeRenameGroupModal()"><%= __('CHAT_GROUP_RENAME_CANCEL') %></button>
    <button class="btn-primary" onclick="submitRenameGroup()"><%= __('CHAT_GROUP_RENAME_SAVE') %></button>
    </div>
  </div>
</div>

<!-- Modal for Creating Group -->
<div id="createGroupModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3><%= __('CHAT_GROUP_CREATE_TITLE') %></h3>
            <button class="modal-close" onclick="closeCreateGroupModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="groupName"><%= __('CHAT_GROUP_CREATE_LABEL') %></label>
                <input type="text" id="groupName" class="form-input" placeholder="<%= __('CHAT_GROUP_CREATE_PLACEHOLDER') %>">
            </div>
            <div class="form-group">
                <label><%= __('CHAT_GROUP_CREATE_PARTICIPANTS') %></label>
                <div class="participant-list" id="participantList">
                    <% allUsers.forEach(user => { %>
                        <% if (user._id.toString() !== currentUserId.toString()) { %>
                            <label class="participant-item">
                                <input type="checkbox" value="<%= user._id %>" class="participant-checkbox">
                                <span class="participant-name"><%= user.username %></span>
                            </label>
                        <% } %>
                    <% }); %>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-secondary" onclick="closeCreateGroupModal()"><%= __('CHAT_GROUP_CREATE_CANCEL') %></button>
            <button class="btn-primary" onclick="createGroup()"><%= __('CHAT_GROUP_CREATE_CREATE') %></button>
        </div>
    </div>
</div>

<!-- Quill Editor -->
<link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.7/quill.js"></script>

<script src="/socket.io/socket.io.js"></script>
<script src="/js/chat/chat-script.js"></script>
<script>
// Collapsible user list section
function toggleUserListSection() {
    var section = document.getElementById('userListSection');
    var list = document.getElementById('userList');
    var icon = document.getElementById('userListToggleIcon');
    if (section.classList.contains('collapsed')) {
        section.classList.remove('collapsed');
        list.style.display = '';
        icon.style.transform = 'rotate(180deg)';
    } else {
        section.classList.add('collapsed');
        list.style.display = 'none';
        icon.style.transform = '';
    }
}
// Ensure collapsed by default and handle chat-main visibility on mobile
document.addEventListener('DOMContentLoaded', function() {
    var section = document.getElementById('userListSection');
    var list = document.getElementById('userList');
    var icon = document.getElementById('userListToggleIcon');
    if (section && list && icon) {
        section.classList.add('collapsed');
        list.style.display = 'none';
        icon.style.transform = '';
    }

    // Mobile: Hide chat-main if no chat selected
    function updateChatMainVisibility() {
        var chatMain = document.getElementById('chatMain');
        var chatWindow = document.getElementById('chatWindow');
        if (!chatMain || !chatWindow) return;
        var isMobile = window.matchMedia('(max-width: 768px)').matches;
        if (isMobile) {
            if (chatWindow.style.display === 'none' || chatWindow.hidden) {
                chatMain.classList.remove('chat-main-visible');
            } else {
                chatMain.classList.add('chat-main-visible');
            }
        } else {
            chatMain.classList.add('chat-main-visible'); // Always visible on desktop
        }
    }
    updateChatMainVisibility();
    window.addEventListener('resize', updateChatMainVisibility);

    // Observe chatWindow display changes
    var chatWindow = document.getElementById('chatWindow');
    if (chatWindow) {
        var observer = new MutationObserver(updateChatMainVisibility);
        observer.observe(chatWindow, { attributes: true, attributeFilter: ['style', 'hidden', 'class'] });
    }
});
</script>
