<div class="chat-container" data-current-user-id="<%= currentUserId %>" data-user-role="<%= userRole %>">
    <!-- Left Sidebar: User List and Groups -->
    <div class="chat-sidebar">
        <!-- Header with Create Group Button -->
        <div class="chat-sidebar-header">
            <h2 class="chat-sidebar-title">Chats</h2>
            <button id="createGroupBtn" class="btn-create-group" title="<%= __('CREATE_GROUP') || 'Neue Gruppe erstellen' %>">
                <i class="fas fa-plus"></i>
                <i class="fas fa-users"></i>
            </button>
        </div>

        <!-- Search Bar -->
        <div class="chat-search-container">
            <input type="text" id="chatSearch" class="chat-search-input" placeholder="<%= __('SEARCH_CHATS') || 'Chats durchsuchen...' %>">
        </div>

        <!-- Chat List -->
        <div class="chat-list" id="chatList">
            <!-- Existing Chats will be rendered here -->
            <% if (userChats && userChats.length > 0) { %>
                <% userChats.forEach(chat => { %>
                    <div class="chat-item" data-chat-id="<%= chat._id %>" data-chat-type="<%= chat.type %>" data-creator-id="<%= chat.creatorId._id %>">
                        <div class="chat-item-avatar">
                            <% if (chat.type === 'group') { %>
                                <i class="fas fa-users"></i>
                            <% } else { %>
                                <% const otherUser = chat.participants.find(p => p._id.toString() !== currentUserId.toString()); %>
                                <div class="user-initials"><%= otherUser ? otherUser.username.substring(0, 2).toUpperCase() : 'U' %></div>
                            <% } %>
                        </div>
                        <div class="chat-item-content">
                            <div class="chat-item-header">
                                <span class="chat-item-name">
                                    <% if (chat.type === 'group') { %>
                                        <%= chat.name %>
                                    <% } else { %>
                                        <% const otherUser = chat.participants.find(p => p._id.toString() !== currentUserId.toString()); %>
                                        <%= otherUser ? otherUser.username : 'User' %>
                                    <% } %>
                                </span>
                                <% if (chat.type === 'group' && (chat.creatorId._id.toString() === currentUserId.toString() || userRole === 'admin')) { %>
                                    <button class="btn-delete-chat" data-chat-id="<%= chat._id %>" title="<%= __('DELETE_CHAT') || 'Gruppe löschen' %>">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                <% } %>
                            </div>
                            <% if (chat.lastMessage) { 
                                const _raw = chat.lastMessage.content || ''; 
                                const _text = _raw.replace(/<[^>]*>/g, ''); 
                                const _snippet = _text.substring(0, 50); 
                            %>
                                <p class="chat-item-preview"><%= _snippet %><%= _text.length > 50 ? '...' : '' %></p>
                            <% } %>
                        </div>
                    </div>
                <% }); %>
            <% } else { %>
                <div class="no-chats-message">
                    <i class="fas fa-comments"></i>
                    <p>Keine Chats vorhanden</p>
                </div>
            <% } %>
        </div>

        <!-- User List Section -->
        <div class="user-list-section">
            <h3 class="user-list-title">Benutzer</h3>
            <div class="user-list" id="userList">
                <% allUsers.forEach(user => { %>
                    <% if (user._id.toString() !== currentUserId.toString()) { %>
                        <div class="user-item" data-user-id="<%= user._id %>">
                            <div class="user-item-avatar">
                                <div class="user-initials"><%= user.username.substring(0, 2).toUpperCase() %></div>
                            </div>
                            <div class="user-item-content">
                                <span class="user-item-name"><%= user.username %></span>
                                <% if (user.role === 'admin') { %>
                                    <span class="user-badge">Admin</span>
                                <% } %>
                            </div>
                        </div>
                    <% } %>
                <% }); %>
            </div>
        </div>
    </div>

    <!-- Right Side: Chat Area -->
    <div class="chat-main">
        <!-- Welcome Screen (shown when no chat is selected) -->
        <div id="welcomeScreen" class="chat-welcome">
            <i class="fas fa-comments"></i>
            <h2>Willkommen im Chat</h2>
            <p>Wähle einen Chat aus der Liste oder starte eine neue Konversation</p>
        </div>

        <!-- Chat Window (hidden by default) -->
        <div id="chatWindow" class="chat-window" style="display: none;">
            <!-- Chat Header -->
            <div class="chat-header">
                <div class="chat-header-info">
                    <h3 id="chatTitle">Chat</h3>
                    <p id="chatSubtitle"></p>
                </div>
                <div class="chat-header-actions">
                    <button id="renameGroupBtn" class="btn-rename-chat" style="display:none;" title="Gruppennamen ändern">
                        <i class="fas fa-pen"></i>
                    </button>
                    <button id="closeChatBtn" class="btn-close-chat">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>

            <!-- Messages Area -->
            <div class="chat-messages" id="chatMessages">
                <!-- Messages will be dynamically inserted here -->
            </div>

            <!-- Message Input (Simple default, Rich on toggle) -->
            <div class="chat-input-container simple-mode">
                <div id="toastContainer" aria-live="polite"></div>
                <!-- Simple row: input + toggle + send -->
                <div class="chat-simple-row" id="simpleRow">
                    <input type="text" id="simpleMessageInput" class="simple-chat-input" placeholder="Kurze Nachricht eingeben..." autocomplete="off" />
                    <button id="editorModeToggle" class="btn-toggle-mode" title="Rich-Editor öffnen">
                        <i class="fas fa-expand"></i>
                    </button>
                    <button id="sendMessageBtn" class="btn-send-message" title="Senden">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
                <!-- Rich editor wrapper (hidden initially) -->
                <div class="chat-editor-wrapper" style="display:none;">
                    <div id="toolbar" class="chat-toolbar">
                        <button class="ql-bold" title="Fett"></button>
                        <button class="ql-italic" title="Kursiv"></button>
                        <button class="ql-underline" title="Unterstrichen"></button>
                        <button class="ql-strike" title="Durchgestrichen"></button>
                        <button class="ql-list" value="ordered" title="Nummerierte Liste"></button>
                        <button class="ql-list" value="bullet" title="Aufzählungsliste"></button>
                        <select class="ql-size" title="Schriftgröße">
                            <option value="small">Klein</option>
                            <option selected>Normal</option>
                            <option value="large">Groß</option>
                            <option value="huge">Sehr Groß</option>
                        </select>
                        <select class="ql-color" title="Textfarbe"></select>
                        <select class="ql-background" title="Hintergrundfarbe"></select>
                        <button class="ql-link" title="Link einfügen"></button>
                        <button class="ql-image" title="Bild hochladen"></button>
                        <button id="fullscreenBtn" class="ql-custom" title="Vollbild">
                            <i class="fas fa-expand"></i>
                        </button>
                    </div>
                    <div id="messageInput" class="chat-input-editor"></div>
                    <div class="chat-input-send-wrapper">
                        <button id="editorModeToggleRich" class="btn-toggle-mode" title="Einfachen Modus aktivieren">
                            <i class="fas fa-compress"></i>
                        </button>
                        <button id="sendMessageBtnRich" class="btn-send-message" title="Senden">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Renaming Group -->
<div id="renameGroupModal" class="modal-overlay" style="display:none;">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Gruppennamen ändern</h3>
      <button class="modal-close" onclick="closeRenameGroupModal()"><i class="fas fa-times"></i></button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label for="renameGroupInput">Neuer Name</label>
        <input type="text" id="renameGroupInput" class="form-input" placeholder="Neuen Gruppennamen eingeben..." />
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-secondary" onclick="closeRenameGroupModal()">Abbrechen</button>
      <button class="btn-primary" onclick="submitRenameGroup()">Speichern</button>
    </div>
  </div>
</div>

<!-- Modal for Creating Group -->
<div id="createGroupModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Neue Gruppe erstellen</h3>
            <button class="modal-close" onclick="closeCreateGroupModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="groupName">Gruppenname</label>
                <input type="text" id="groupName" class="form-input" placeholder="Gruppenname eingeben...">
            </div>
            <div class="form-group">
                <label>Teilnehmer auswählen</label>
                <div class="participant-list" id="participantList">
                    <% allUsers.forEach(user => { %>
                        <% if (user._id.toString() !== currentUserId.toString()) { %>
                            <label class="participant-item">
                                <input type="checkbox" value="<%= user._id %>" class="participant-checkbox">
                                <span class="participant-name"><%= user.username %></span>
                            </label>
                        <% } %>
                    <% }); %>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-secondary" onclick="closeCreateGroupModal()">Abbrechen</button>
            <button class="btn-primary" onclick="createGroup()">Erstellen</button>
        </div>
    </div>
</div>

<!-- Quill Editor -->
<link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.7/quill.js"></script>

<script src="/socket.io/socket.io.js"></script>
<script src="/js/chat/chat-script.js"></script>
