server {
    listen 80;

    # ----------------------------------------------
    # 1. HAUPTANWENDUNG (Node.js App auf Port 4000)
    # Erreichbar über http://localhost/onis/
    # ----------------------------------------------
    
    # OPTIONAL: Leitet http://localhost/onis auf http://localhost/onis/ um
    location = /onis {
        return 301 /onis/;
    }

    location /onis/ {
        proxy_pass http://web:4000/;

        # SUBSTITUTIONSFILTER, um absolute Pfade im HTML zu korrigieren
        # 1. Sicherstellen, dass Nginx die Antwort dekomprimieren kann, bevor es den Filter anwendet
        proxy_set_header Accept-Encoding ""; 
        
        # 2. Definiert, auf welche MIME-Typen der Filter angewendet werden soll
        sub_filter_types text/html;
        
        # 3. 'off' bedeutet, dass der Filter mehrmals im Dokument ausgeführt wird (wichtig!)
        sub_filter_once off;
        
        # 4. Ersetzt absolute URLs: src="/css/..." -> src="/onis/css/..."
        sub_filter 'src="/' 'src="/onis/';
        
        # 5. Ersetzt absolute URLs: href="/styles/..." -> href="/onis/styles/..."
        sub_filter 'href="/' 'href="/onis/';

        # Korrigiert interne Backend-Redirects (z.B. Location: /dashboard) 
        # auf den externen Pfad (z.B. Location: /onis/dashboard).
        # HINWEIS: Dies löst nur HTTP-Redirects, nicht hartkodierte Links im Frontend-Code.
        proxy_redirect default; 
        proxy_redirect ~^/(.*)$ /onis/$1;
        proxy_redirect http://localhost:4000/ /onis/; # Sonderfall für die Root-Umleitung

        # Standard-Proxy-Header
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # ----------------------------------------------
    # 2. MONGODB WEB-GUI (Mongo Express auf Port 8081)
    # Erreichbar über http://localhost/mongo/
    # ----------------------------------------------
    location /mongo/ {
        proxy_pass http://mongo-express:8081/; 
        
        # Sicherstellen, dass die Header für den Proxy korrekt übergeben werden
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # ----------------------------------------------------
        # REDIRECT-KORREKTUREN für Mongo Express:
        # Mongo Express sendet Redirects oft auf die Wurzel (/)
        # Wir müssen diese auf den korrekten Pfad umleiten.
        # ----------------------------------------------------
        proxy_redirect default;
        proxy_redirect ~^/(.*)$ /mongo/$1;
        
        # ----------------------------------------------------
        # Subfilter für Mongo Express Styles/Skripte (wie von Ihnen eingerichtet)
        # ----------------------------------------------------
        proxy_set_header Accept-Encoding ""; 
        
        sub_filter_types text/html;
        sub_filter_once off;
        
        # Achtung: Die nachfolgenden sub_filter sind wichtig, aber können in manchen
        # Fällen auch Probleme verursachen. Sie sind korrekt, um absolute Pfade
        # im HTML zu korrigieren.
        sub_filter 'href="/' 'href="/mongo/';
        sub_filter 'src="/' 'src="/mongo/';
    }
}