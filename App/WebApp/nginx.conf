server {
    listen 80;

    # Hauptanwendung (Node.js App)
    # Erreichbar über http://localhost/
    location / {
        proxy_pass http://web:4000/; # 'web' ist der Service-Name in docker-compose
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # MongoDB Web-GUI (Mongo Express)
    # Erreichbar über http://localhost/mongo/
    location /mongo/ {
        proxy_pass http://mongo-express:8081/; 
        
        # Sicherstellen, dass die Header für den Proxy korrekt übergeben werden
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # ----------------------------------------------------
        # WICHTIG: Subfilter für Mongo Express Styles/Skripte
        # Ersetzt Links im HTML-Code, damit Styles geladen werden.
        # ----------------------------------------------------
        # Stellt sicher, dass die Antwort dekomprimiert wird, damit sub_filter funktioniert
        proxy_set_header Accept-Encoding ""; 
        
        # Aktiviert das Subfilter-Modul für diese Location
        sub_filter_types text/html;
        sub_filter_once off;
        
        # Ersetzt Links wie src="/js/..." oder href="/css/..." mit src="./mongo/js/..."
        # Der Back-End-Pfad / wird durch den öffentlichen Subpfad /mongo/ ersetzt.
        sub_filter 'href="/' 'href="/mongo/';
        sub_filter 'src="/' 'src="/mongo/';
    }
}